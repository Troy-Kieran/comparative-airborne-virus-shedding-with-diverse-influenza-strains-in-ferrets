########################################################################################
########################################################################################
### Influenza Aerosol PFU/RNA Data Analysis - Several Viruses
### experimental data generated by Joanna Pulit-Penaloza
### primary analyses and plots
### 30 April 2025 - 12 November 2025
### Troy J. Kieran
########################################################################################
########################################################################################
### Load packages
library(tidyverse)
library(tidylog)
library(patchwork)

source("//cdc.gov/adp/FCID_DVRD_2_FLU/PATHOGENESIS TEAM/data science program/useful_functions_TJK.R")

########################################################################################
### set working directory. Should be defaulted to it if opening the file from its location
#setwd("//cdc.gov/adp/FCID_DVRD_2_FLU/PATHOGENESIS TEAM/1Joanna/Lab/AR")

########################################################################################
### Import Data

norm_data <- read.csv("R_inputs/fullData_normalized.csv", header = TRUE, check.names = FALSE)
## drop added row number column
norm_data <- norm_data[, -1]

## rename viruses to add the /
norm_data$Virus <- str_replace_all(norm_data$Virus, "(\\D)(\\d)", "\\1/\\2")
norm_data$Virus <- ifelse(norm_data$Virus == "BC", "BC/PHL", norm_data$Virus)

## set Sample & Virus levels
norm_data$Sample <- factor(norm_data$Sample, levels = c("NW", "NIOSH", "SPOT"))
norm_data$Virus <- factor(norm_data$Virus, 
                          levels = c("NE/14", "AL/39", "Anhui/1", "MI/90", "CO/137", 
                                     "CA/147", "BC/PHL", "WA/239", "VN/1203"))

########################################################################################

## rename labels for plots
virus_sample_labels <- as_labeller(c(
  "BC/PHL" = "BC/PHL",
  "CA/147" = "CA/147",
  "CO/137" = "CO/137",
  "AL/39" = "AL/39",
  "Anhui/1" = "Anhui/1",
  "MI/90" = "MI/90",
  "NE/14" = "NE/14",
  "VN/1203" = "VN/1203",
  "WA/239" = "WA/239",
  "NW" = "Nasal Wash (NW)",
  "NIOSH" = "Air / BC 251",
  "SPOT" = "Air / SPOT",
  "d1" = "d1", "d2" = "d2", "d3" = "d3", "d5" = "d5",
  "PFU" = "PFU", "RNA" = "RNA", "ratio" = "Ratio (RNA/PFU)",
  "High-transmissible" = "High-transmissible", 
  "Low-transmissible" = "Low-transmissible", 
  "Non-transmissible" = "Non-transmissible",
  "non-transmissible" = "Non-transmissible",
  "transmissible" = "Transmissible"))

## adjustments for particular plots
virus_sample_labels2 <- as_labeller(c(
  "BC/PHL" = "BC/PHL",
  "CA/147" = "CA/147",
  "CO/137" = "CO/137",
  "AL/39" = "AL/39",
  "Anhui/1" = "Anhui/1",
  "MI/90" = "MI/90",
  "NE/14" = "NE/14",
  "VN/1203" = "VN/1203",
  "WA/239" = "WA/239",
  "NW" = "Nasal Wash (NW)",
  "NIOSH" = "Air / BC 251",
  "SPOT" = "Air / SPOT",
  "d1" = "d1", "d2" = "d2", "d3" = "d3", "d5" = "d5",
  "PFU" = "Infectious Virus", "RNA" = "Viral RNA", "ratio" = "Ratio (RNA/PFU)",
  "High-transmissible" = "High-transmissible", 
  "Low-transmissible" = "Low-transmissible", 
  "Non-transmissible" = "Non-transmissible",
  "non-transmissible" = "Non-transmissible",
  "transmissible" = "Transmissible"))

########################################################################################
########################################################################################

### Overall summary stats

norm_data %>% 
  #filter(Sample != 'NW') %>%
  group_by(Sample) %>%
  summarise(mean_RNA = mean(RNA, na.rm = TRUE),
            ci_lower_RNA = mean(RNA, na.rm = TRUE) - 1.96 * sd(RNA, na.rm = TRUE) / sqrt(n()),
            ci_upper_RNA = mean(RNA, na.rm = TRUE) + 1.96 * sd(RNA, na.rm = TRUE) / sqrt(n()),
            mean_PFU = mean(PFU, na.rm = TRUE),
            ci_lower_PFU = mean(PFU, na.rm = TRUE) - 1.96 * sd(PFU, na.rm = TRUE) / sqrt(n()),
            ci_upper_PFU = mean(PFU, na.rm = TRUE) + 1.96 * sd(PFU, na.rm = TRUE) / sqrt(n()),
            mean_ratio = mean(ratio, na.rm = TRUE),
            ci_lower_ratio = mean(ratio, na.rm = TRUE) - 1.96 * sd(ratio, na.rm = TRUE) / sqrt(n()),
            ci_upper_ratio = mean(ratio, na.rm = TRUE) + 1.96 * sd(ratio, na.rm = TRUE) / sqrt(n()),
            ## medians
            median_RNA = median(RNA, na.rm = TRUE),
            median_PFU = median(PFU, na.rm = TRUE),
            median_ratio = median(ratio, na.rm = TRUE)) %>% View()

## ratio with out zero values
norm_data %>% 
  #filter(Sample != 'NW') %>%
  filter(ratio > 0) %>%
  group_by(Sample) %>%
  summarise(mean_ratio = mean(ratio, na.rm = TRUE),
            ci_lower_ratio = mean(ratio, na.rm = TRUE) - 1.96 * sd(ratio, na.rm = TRUE) / sqrt(n()),
            ci_upper_ratio = mean(ratio, na.rm = TRUE) + 1.96 * sd(ratio, na.rm = TRUE) / sqrt(n()),
            median_ratio = median(ratio, na.rm = TRUE)) %>% View()

########################################################################################
########################################################################################
### FIGURES ###
########################################################################################
########################################################################################

### FIGURE 1

## R recreation of the figure from GraphPad Prisim

## inoculated and contact titer data
## converted RDT day 9 blanks to 3 and NC to blank (NA)
air <- read.csv("R_inputs/Figure_1_source_data_air.csv", header = TRUE, check.names = FALSE)

air <- air %>% 
  pivot_longer(cols = c(d1:d9), names_to = "day", values_to = "PFU") %>%
  mutate(PFU = log10(PFU),
         genotype = as.factor(genotype),
         group = as.factor(group),
         pair_id = str_extract(ferret, "\\d+"),
         pair_id = paste0("pair", pair_id) ) 

air$day <- as.numeric(str_remove_all(air$day, "[^0-9]"))

## define the desired x order
x_levels <- c("Inoc_1","Inoc_3","Inoc_5","Inoc_7",
              "DCT_1","DCT_3","DCT_5","DCT_7","DCT_9",
              "RDT_1","RDT_3","RDT_5","RDT_7","RDT_9")

air <- air %>%
  mutate(x_key = factor(paste(expt, day, sep = "_"), levels = x_levels))

name_map <- c(A = "CO/137", B = "CO/137", C = "CA/147",
              D = "WA/239", E = "WA/239", 'F' = "BC/PHL",
              'Genotype B3.13' = "Genotype B3.13",
              'Genotype D1.1' = "Genotype D1.1")

air %>%
  filter(group %in% c("A", "B", "C")) %>%
  drop_na(x_key) %>%
  ggplot(aes(x = x_key, y = PFU, fill = interaction(group, pair_id), group = pair_id)) +
  stat_summary(fun = mean, geom = "bar", width = 0.7,
               position = position_dodge2(preserve = "single")) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1, color = 'red3') +
  geom_vline(xintercept = 4.5, linetype = "dashed") +
  facet_grid(rows = vars(genotype), cols = vars(group), scales = "free_x",
             drop = TRUE, labeller = as_labeller(name_map), switch = "y") +
  scale_fill_viridis_d(name = "ferret", end = 0.95, option = "mako") +
  ## nested guide split expt_day
  scale_x_discrete(name = "Day",
                   guide = ggh4x::guide_axis_nested(delim = "_")) +
  scale_y_continuous(breaks = c(0:7)) +
  labs(y = "Viral Titers (log10 PFU / ml)") +
  theme_bw() +
  theme(legend.position = "none") #-> geno_b

air %>%
  filter(group %in% c("D", "E", "F")) %>%
  drop_na(x_key) %>%
  ggplot(aes(x = x_key, y = PFU, fill = interaction(group, pair_id), group = pair_id)) +
  stat_summary(fun = mean, geom = "bar", width = 0.7,
               position = position_dodge2(preserve = "single")) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1, color = 'red3') +
  geom_vline(xintercept = 4.5, linetype = "dashed") +
  facet_grid(rows = vars(genotype), cols = vars(group), scales = "free_x",
             drop = TRUE, labeller = as_labeller(name_map), switch = "y") +
  scale_fill_viridis_d(name = "ferret", end = 0.8, option = "cividis") +
  ## nested guide split expt_day
  scale_x_discrete(name = "Day",
                   guide = ggh4x::guide_axis_nested(delim = "_")) +
  scale_y_continuous(breaks = c(0:7)) +
  labs(y = "Viral Titers (log10 PFU / ml)") +
  theme_bw() +
  theme(legend.position = "none") #-> geno_d

###

## tissue titer data
tis <- read.csv("R_inputs/Figure_1_source_data_tissue.csv", header = TRUE, check.names = FALSE)

virus_order  <- c("CO137", "CA147", "WA239", "BC")

tis <- tis %>% pivot_longer(
  cols = c(blood:rs),
  names_to = "Tissue",
  values_to = "PFU") %>%
  mutate(PFU = log10(PFU),
         Virus = fct_relevel(Virus, virus_order)) %>%
  mutate(Tissue = fct_relevel(Tissue, "blood", "lung", "trachea", "nt", "brain", 
                              "ob", "spleen", "liver", "intestine", "rs"),
         Tissue = fct_recode(Tissue, "Blood" = "blood", "Lung" = "lung",
                             "Trachea" = "trachea", "Nasal Tur" = "nt", "Brain" = "brain",
                             "Olfact Bulb" = "ob", "Spleen" = "spleen", "Liver" = "liver",
                             "Intestine" = "intestine", "Rect Swab" = "rs"))

virus_labels <- c("CO137.d3" = "CO/137 d3 B3.13",
                  "CA147.d4" = "CA/147 d4 B3.13", "CA147.d5" = "CA/147 d5 B3.13",
                  "WA239.d3" = "WA/239 d3 D1.1",
                  "BC.d4" = "BC/PHL d4 D1.1", "BC.d5" = "BC/PHL d5 D1.1")

virusday_order <- c("CO137.d3", "CA147.d4", "CA147.d5",
                    "WA239.d3", "BC.d4", "BC.d5")

tis %>% ggplot(aes(x = Tissue, y = PFU, fill = interaction(Virus, day), 
                   group = interaction(ferret, Virus))) +
  stat_summary(fun = mean, geom = "bar", width = 0.7,
               position = position_dodge2(preserve = "single")) +
  scale_fill_viridis_d(name = "Virus", end = 0.9, option = "inferno",
                       labels = virus_labels, limits = virusday_order,
                       breaks = virusday_order, ) +
  scale_y_continuous(breaks = 0:9) +
  geom_hline(yintercept = 1, linetype = "dotted", linewidth = 1, color = 'red3') +
  labs(y = "Viral Titers (log10 PFU / ml or g)", x = NULL) +
  theme_bw() +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 1)) #-> plot_tis

## patchwork and export
pfu_plot <- geno_b / geno_d / plot_tis

# ragg::agg_tiff(filename = "Figure 1 TJK R version.tiff",
#                width = 6.7, height = 7, units = 'in', res = 600,
#                scaling = 0.75, compression = "lzw")
# plot(pfu_plot)
# invisible(dev.off())

########################################################################################

### FIGURE 2

## summarize data for plots & Supplemental Table 2
data_stats <-
  norm_data %>%
  group_by(Virus, day, Sample) %>%
  #mutate(RNA = ifelse(RNA == 0, 1.5, RNA)) %>%
  summarise(Nr = sum(!is.na(RNA)),
            Np = sum(!is.na(PFU)),
            mr = mean(RNA),
            ser = sd(RNA)/sqrt(length(RNA)),
            mp = mean(PFU),
            sep = sd(PFU)/sqrt(length(PFU)),
            sdr = sd(RNA),
            sdp = sd(PFU),
            ## Coefficient of Variation (CV)
            cvr = ((sdr/mr) * 100),
            cvp = ((sdp/mp) * 100),
            ## https://pmc.ncbi.nlm.nih.gov/articles/PMC9196089/
            ## Robust CV Based on Interquartile Range (RCVð‘„)
            rcvqr = ((0.75 * (IQR(RNA)/median(RNA))) * 100),
            rcvqp = ((0.75 * (IQR(PFU)/median(PFU))) * 100),
            ## Robust CV Based on Median Absolute Deviation (RCVð‘€)
            rcvmr = ((1.4826 * (mad(RNA)/median(RNA))) * 100),
            rcvmp = ((1.4826 * (mad(PFU)/median(PFU))) * 100)) %>%
  mutate(VirusGroup = case_when(
    Virus %in% c("NE/14", "AL/39") ~ "High-transmissible",
    Virus %in% c("Anhui/1", "MI/90") ~ "Low-transmissible",
    TRUE ~ "Non-transmissible"))

## set Virus and transmissibility levels/order
data_stats$Virus <- factor(data_stats$Virus, 
                           levels = c("NE/14", "AL/39", "Anhui/1", "MI/90", "CO/137", 
                                      "CA/147", "BC/PHL", "WA/239", "VN/1203"))

data_stats$VirusGroup <- factor(data_stats$VirusGroup,
                                levels = c("High-transmissible", 
                                           "Low-transmissible", 
                                           "Non-transmissible"))

## for adding individual data points
norm_data_reduced <- norm_data %>%
  select(Virus, day, Sample, PFU, RNA) %>%
  mutate(VirusGroup = case_when(
    Virus %in% c("NE/14", "AL/39") ~ "High-transmissible",
    Virus %in% c("Anhui/1", "MI/90") ~ "Low-transmissible",
    TRUE ~ "Non-transmissible"))

## plot PFU & RNA w/ standard error
## Bar (PFU) & Line (RNA) plots
data_stats %>%
  ggplot(aes(x = day, color = Sample, fill = Sample)) +
  geom_bar(aes(y = mp), stat = "identity", alpha = 0.4, 
           position = position_dodge(width = 0.95)) +
  geom_jitter(aes(x = day, y =  PFU, color = Sample, fill = Sample), 
              shape = 17, size = 1.5, data = norm_data_reduced) +
  geom_errorbar(aes(ymin = mp - sep, ymax = mp + sep), 
                width = 0.2, alpha = 0.7, color = "black") +
  geom_ribbon(aes(group = 1, ymin = mr - ser, ymax = mr + ser), 
              fill = "darkslategray4", alpha = 0.2) +
  #geom_point(aes(y = mr), size = 2, alpha = 1) +
  geom_line(aes(y = mr, group = 1), size = 0.8, alpha = 1) +
  geom_jitter(aes(x = day, y =  RNA, color = Sample, fill = Sample), 
              shape = 15, size = 1.5, data = norm_data_reduced) +
  ## have facets for transmissibility & Virus
  ggh4x::facet_nested(rows = vars(Sample), cols = vars(VirusGroup, Virus),
                      labeller = labeller(Sample = virus_sample_labels,
                                          Virus = virus_sample_labels,
                                          VirusGroup = label_value),
                      scales = "free_y", space = "fixed", render_empty = FALSE) +
  scale_fill_viridis_d(end = 0.8, labels = virus_sample_labels) +
  scale_color_viridis_d(end = 0.8, labels = virus_sample_labels) +
  scale_y_continuous(
    name = expression(log[10]~paste("PFU  (bars)")),
    breaks = seq(0, 11, by = 1),
    sec.axis = sec_axis(~., name = expression(log[10]~paste("RNA copies  (lines)")),
                        breaks = seq(0, 11, by = 1))) +
  xlab("Day Post-Inoculation") +
  theme_bw() +
  theme(legend.position = 'bottom', 
        legend.title = element_blank(),
        strip.text = element_text(face = "bold"),
        strip.background = element_rect(fill = "grey95"),
        axis.title = element_text(face = "bold"),
        axis.text = element_text(face = "bold")) #-> p1

# ragg::agg_tiff(filename = "Figure_2_PFU_RNA_VirusvSample.tiff",
#                width = 9, height = 8, units = 'in', res = 600,
#                scaling = 1, compression = "lzw")
# plot(p1)
# invisible(dev.off())

########################################################################################

### FIGURE 3

## pairwise NIOSH v SPOT by transmission category

## transform data long
data_long <- norm_data %>%
  pivot_longer(
    cols = c(PFU, RNA, ratio, AUC_PFU, AUC_RNA, ratio_auc),
    names_to = "Variable",
    values_to = "Value")

## calculate means
data_means <- data_long %>%
  filter(Sample != 'NW') %>%
  group_by(Sample, Variable, trans_3cat) %>%
  summarise(mean_value = mean(Value, na.rm = TRUE)) 

data_means_ratio <- data_long %>%
  filter(Sample != 'NW') %>%
  filter(Variable == 'ratio', Value > 0) %>%
  group_by(Sample, Variable, trans_3cat) %>%
  summarise(mean_value = mean(Value, na.rm = TRUE)) 

## plot

data_long %>%
  filter(Sample != 'NW') %>%
  filter(Value > 0) %>% 
  subset(Variable %in% 'ratio') %>%
  distinct() %>%
  ggplot(aes(x = Sample, y = Value, fill = Sample, color = Sample)) +
  geom_jitter(alpha = 0.8, width = 0.25) +
  geom_boxplot(alpha = 0.3, width = 0.2) +
  geom_violin(alpha = 0.2) +
  geom_point(data = data_means_ratio, aes(y = mean_value), 
             color = 'red3', size = 3, show.legend = FALSE) +
  facet_grid(Variable ~ trans_3cat,scales = "free_y", labeller = virus_sample_labels) +
  ggpubr::stat_compare_means(comparisons = list(c("NIOSH", "SPOT")),
                             size = 4, method = 'wilcox.test', label = 'p.format') +
  labs(y = expression("log"[10]*" (RNA copies / PFU)")) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = 'bottom',
        legend.title = element_blank(), 
        panel.grid = element_blank(),
        strip.background = element_rect(fill = "grey95")) +
  scale_y_continuous(breaks = seq(1, 7, by = 1),
                     expand = c(0, 0.5)) +
  scale_fill_viridis_d(begin = 0.4, end = 0.7, labels = virus_sample_labels) +
  scale_color_viridis_d(begin = 0.4, end = 0.7, labels = virus_sample_labels) #-> plot_trans_ratio

data_long %>%
  filter(Sample != 'NW') %>%
  subset(Variable %in% 'RNA') %>%
  distinct() %>%
  ggplot(aes(x = Sample, y = Value, fill = Sample, color = Sample)) +
  geom_jitter(alpha = 0.8, width = 0.25) +
  geom_boxplot(alpha = 0.3, width = 0.2) +
  geom_violin(alpha = 0.2) +
  geom_point(data = data_means %>% filter(Variable == "RNA"), aes(y = mean_value), 
             color = 'red3', size = 3, show.legend = FALSE) +
  facet_grid(Variable ~ trans_3cat,scales = "free_y", labeller = virus_sample_labels2) +
  ggpubr::stat_compare_means(comparisons = list(c("NIOSH", "SPOT")),
                             size = 4, method = 'wilcox.test', label = 'p.format') +
  labs(y = expression("log"[10]*" RNA copies")) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = 'none',
        legend.title = element_blank(), 
        panel.grid = element_blank(),
        strip.background = element_rect(fill = "grey95")) +
  scale_y_continuous(breaks = seq(0, 8, by = 1),
                     expand = c(0, 0.9)) +
  scale_fill_viridis_d(begin = 0.4, end = 0.7, labels = virus_sample_labels) +
  scale_color_viridis_d(begin = 0.4, end = 0.7, labels = virus_sample_labels) #-> plot_trans_rna

data_long %>%
  filter(Sample != 'NW') %>%
  subset(Variable %in% 'PFU') %>%
  distinct() %>%
  ggplot(aes(x = Sample, y = Value, fill = Sample, color = Sample)) +
  geom_jitter(alpha = 0.8, width = 0.25) +
  geom_boxplot(alpha = 0.3, width = 0.2) +
  geom_violin(alpha = 0.2) +
  geom_point(data = data_means %>% filter(Variable == "PFU"), aes(y = mean_value), 
             color = 'red3', size = 3, show.legend = FALSE) +
  facet_grid(Variable ~ trans_3cat, scales = "free_y", labeller = virus_sample_labels2) +
  ggpubr::stat_compare_means(comparisons = list(c("NIOSH", "SPOT")),
                             size = 4, method = 'wilcox.test', label = 'p.format') +
  labs(y = expression("log"[10]*" PFU")) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = 'none',
        legend.title = element_blank(), 
        panel.grid = element_blank(),
        strip.background = element_rect(fill = "grey95")) +
  scale_y_continuous(breaks = seq(0, 7, by = 1),
                     expand = c(0, 0.5)) +
  scale_fill_viridis_d(begin = 0.4, end = 0.7, labels = virus_sample_labels) +
  scale_color_viridis_d(begin = 0.4, end = 0.7, labels = virus_sample_labels) #-> plot_trans_pfu


plot_trans <- plot_trans_pfu / plot_trans_rna / plot_trans_ratio + 
  plot_annotation(tag_levels = 'a')

# ragg::agg_tiff(filename = "Figure_3_transmisison_wilcox_compare.tiff",
#                width = 5, height = 7, units = 'in', res = 600,
#                scaling = 0.9, compression = "lzw")
# plot(plot_trans)
# invisible(dev.off())

########################################################################################

### FIGURE 4 - Correlation plots

#scales::show_col(viridis::viridis(n = 25, option = 'magma'))

## NW v NIOSH

## AUC PFU by transmissible
p_AUC_PFU_stat <- data_long %>% 
  select(Sample, Variable, Value, trans_3cat) %>%
  distinct() %>%
  filter(Sample != "SPOT", 
         Variable == "AUC_PFU") %>% 
  ggplot(aes(x = trans_3cat, y = Value, fill = trans_3cat, color = trans_3cat)) +
  geom_boxplot(alpha = 0.4) +
  geom_point() +
  geom_boxplot(alpha = 0.4) +
  facet_wrap(~ Sample, scales = "free_y", 
             labeller = as_labeller(c(NW = "Nasal Wash", NIOSH = "Air / BC 251", SPOT = "Air / SPOT"))) + 
  ## accurate Dunn test p-values
  ggpubr::geom_pwc(method = 'dunn_test', label = 'p.adj.signif', hide.ns = TRUE) +
  ## overall Kruskal-Wallis stat
  # ggpubr::stat_kruskal_test(label = "p.format", label.y.npc = "bottom", 
  #                           label.x.npc = "center", hjust = 0.5,
  #                           size = 6, fontface = "bold") +
  ## not consistent with Dunn, Wilcox p-values
  # ggpubr::stat_compare_means(comparisons = list(c("High-transmissible", "Low-transmissible"),
  #                                               c("Non-transmissible", "Low-transmissible"),
  #                                               c("High-transmissible", "Non-transmissible")),
  #                            size = 6, step.increase = 0.5, label = "p.signif", method = "wilcox.test") +
  theme_void() +
  labs(y = expression("log"[10]*" Value")) +
  ylim(NA, max(data_long$Value) + 0.6) +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        strip.text = element_text(size = 15),
        #panel.background = element_rect(fill = 'white', color = 'white'),
        plot.background = element_rect(color = "black", size = 1, fill = 'white')) +
  scale_fill_viridis_d(begin = 0.2, end = 0.75, option = 'magma') +
  scale_color_viridis_d(begin = 0.2, end = 0.75, option = 'magma')

norm_data %>%
  group_by(Virus, ferret) %>%
  mutate(Sample2 = case_when(Sample == 'NW' ~ 'NW', 
                             Sample == 'NIOSH' ~ 'Air', 
                             Sample == 'SPOT' ~ 'Air'),
         occurrence = row_number()) %>%
  ungroup() %>%
  filter(Sample != 'SPOT') %>%
  pivot_wider(names_from = Sample2, values_from = c(AUC_PFU, AUC_RNA),
              id_cols = c(Virus, day, ferret, trans_3cat)) %>%
  unnest(cols = everything()) %>% 
  distinct() %>%
  #subset(!(Virus %in% c("CA147", "CO137"))) %>%
  ggplot(aes(x = AUC_PFU_NW, y = AUC_PFU_Air, color = trans_3cat)) + 
  geom_smooth(method = 'lm', se = TRUE, color = "darkorchid4", 
              alpha = 0.2, linetype = 'dashed') +
  geom_point(size = 6, alpha = 0.9) +
  ggrepel::geom_text_repel(aes(label = Virus), size = 5, 
                           data = . %>% group_by(AUC_PFU_NW, AUC_PFU_Air) %>% slice(1)) +
  ggpubr::stat_cor(aes(x = AUC_PFU_NW, y = AUC_PFU_Air), method = "pearson", 
                   label.x.npc = "left", label.y.npc = 'top', size = 5) + 
  ggpubr::stat_cor(aes(x = AUC_PFU_NW, y = AUC_PFU_Air), method = "pearson", 
                   label.y.npc = 0.85, label.x.npc = 'left', size = 5, color = 'black') +
  #ggpp::stat_group_counts(label.x = 'right', label.y = 'top', vstep = 0.02) +
  #facet_grid(~ Virus, labeller = virus_sample_labels) +
  labs(title = 'a',
       x = "Nasal Wash PFU Area Under the Curve of Days 1-3",
       y = "Airborne PFU Area Under the Curve of Days 1-3") +
  theme_bw() +
  theme(legend.position = 'bottom',
        axis.text = element_text(size = 14, face = "bold"),
        axis.title = element_text(size = 16, face = "bold"),
        legend.text = element_text(size = 14, face = "bold"),
        legend.title = element_blank()) +
  scale_color_viridis_d(begin = 0.2, end = 0.75, option = 'magma') +
  annotation_custom(ggplotGrob(p_AUC_PFU_stat), 
                    xmin = 7, xmax = Inf, ymin = -Inf, ymax = 0.95) #-> plot_cor_pfu

# ragg::agg_tiff(filename = "Figure_correlation_NWvNIOSH_AUC_PFU.tiff",
#                width = 9, height = 11, units = 'in', res = 600, 
#                scaling = 1, compression = "lzw")
# plot(plot_cor_pfu)
# invisible(dev.off())

###

## AUC RNA by transmissible
p_AUC_RNA_stat <- data_long %>% 
  select(Sample, Variable, Value, trans_3cat) %>%
  distinct() %>%
  filter(Sample != "SPOT", 
         Variable == "AUC_RNA") %>%
  ggplot(aes(x = trans_3cat, y = Value, fill = trans_3cat, color = trans_3cat)) +
  geom_boxplot(alpha = 0.4) +
  geom_point() +
  geom_boxplot(alpha = 0.4) +
  facet_wrap(~ Sample, scales = "free_y", 
             labeller = as_labeller(c(NW = "Nasal Wash", NIOSH = "Air / BC 251", SPOT = "Air / SPOT"))) + 
  ## accurate Dunn test p-values
  ggpubr::geom_pwc(method = 'dunn_test', label = 'p.adj.signif', hide.ns = TRUE) +
  ## overall Kruskal-Wallis stat
  # ggpubr::stat_kruskal_test(label = "p.format", label.y.npc = "bottom", 
  #                           label.x.npc = "center", hjust = 0.5,
  #                           size = 6, fontface = "bold") +
  ## not consistent with Dunn, Wilcox p-values
  # ggpubr::stat_compare_means(comparisons = list(c("High-transmissible", "Low-transmissible"),
  #                                               c("Non-transmissible", "Low-transmissible"),
  #                                               c("High-transmissible", "Non-transmissible")), 
  #                            size = 6, step.increase = 0.16, label = "p.signif", method = "wilcox.test") +
  theme_void() +
  labs(y = expression("log"[10]*" Value")) +
  ylim(NA, max(data_long$Value) + 0.75) +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        strip.text = element_text(size = 15),
        #panel.background = element_rect(fill = 'white', color = 'white'),
        plot.background = element_rect(color = "black", size = 1, fill = 'white')) +
  scale_fill_viridis_d(begin = 0.2, end = 0.75, option = 'magma') +
  scale_color_viridis_d(begin = 0.2, end = 0.75, option = 'magma')


norm_data %>%
  group_by(Virus, ferret) %>%
  mutate(Sample2 = case_when(Sample == 'NW' ~ 'NW', 
                             Sample == 'NIOSH' ~ 'Air', 
                             Sample == 'SPOT' ~ 'Air'),
         occurrence = row_number()) %>%
  ungroup() %>%
  filter(Sample != 'SPOT') %>%
  pivot_wider(names_from = Sample2, values_from = c(AUC_PFU, AUC_RNA),
              id_cols = c(Virus, day, ferret, trans_3cat)) %>%
  unnest(cols = everything()) %>% 
  distinct() %>% 
  #subset(!(Virus %in% c("CA147", "CO137", "MI90"))) %>%
  ggplot(aes(x = AUC_RNA_NW, y = AUC_RNA_Air, color = trans_3cat)) + 
  geom_smooth(method = 'lm', se = TRUE, color = "darkorchid4", 
              alpha = 0.2, linetype = 'dashed') +
  geom_point(size = 6, alpha = 0.9) +
  ggrepel::geom_text_repel(aes(label = Virus), size = 5, 
                           data = . %>% group_by(AUC_RNA_NW, AUC_RNA_Air) %>% slice(1)) +
  ggpubr::stat_cor(aes(x = AUC_RNA_NW, y = AUC_RNA_Air), method = "pearson", 
                   label.x.npc = "left", label.y.npc = 'top', size = 5) + 
  ggpubr::stat_cor(aes(x = AUC_RNA_NW, y = AUC_RNA_Air), method = "pearson", 
                   label.y.npc = 0.85, label.x.npc = 'left', size = 5, color = 'black') +
  #ggpp::stat_group_counts(label.x = 'right', label.y = 'top', vstep = 0.02) +
  #facet_grid(~ Virus, labeller = virus_sample_labels) +
  labs(title = 'b',
       x = "Nasal Wash RNA Area Under the Curve of Days 1-3",
       y = "Airborne RNA Area Under the Curve of Days 1-3") +
  theme_bw() +
  theme(legend.position = 'bottom',
        axis.text = element_text(size = 14, face = "bold"),
        axis.title = element_text(size = 16, face = "bold"),
        legend.text = element_text(size = 14, face = "bold"),
        legend.title = element_blank()) +
  scale_color_viridis_d(begin = 0.2, end = 0.8, option = 'magma') +
  annotation_custom(ggplotGrob(p_AUC_RNA_stat), 
                    xmin = 9.7, xmax = Inf, ymin = -Inf, ymax = 4.5) #-> plot_cor_rna

# ragg::agg_tiff(filename = "Figure_correlation_NWvNIOSH_AUC_RNA.tiff",
#                width = 9, height = 11, units = 'in', res = 600, 
#                scaling = 1, compression = "lzw")
# plot(plot_cor_rna)
# invisible(dev.off())

## combine plots
p23 <- plot_cor_pfu + plot_cor_rna #+ plot_annotation(tag_levels = 'A')
# ragg::agg_tiff(filename = "Figure_4_correlation_NWvNIOSH_AUC_PFU-RNA.tiff",
#                width = 12, height = 11, units = 'in', res = 600,
#                scaling = 0.8, compression = "lzw")
# plot(p23)
# invisible(dev.off())

########################################################################################

### FIGURE 5 - GLM Probabilities

data <- norm_data %>% filter(Sample == 'NIOSH') %>%
  mutate(trans_cat = as.factor(trans_cat))

model <- glm(trans_cat ~ AUC_PFU, data = data, family = binomial())
preds <- predict(model, newdata = data, type = "response")
data$pred_AUC_PFU <- preds

model <- glm(trans_cat ~ AUC_RNA, data = data, family = binomial())
preds <- predict(model, newdata = data, type = "response")
data$pred_AUC_RNA <- preds

data %>% select(Virus, AUC_PFU, AUC_RNA, trans, trans_cat, pred_AUC_PFU, pred_AUC_RNA) %>% distinct() %>% View()

###

plot_prob_threshold <- function(data, outcome, predictor, prob_thresholds = c(0.5, 0.75), 
                                n_points = 500, link = "logit", xlabel = NULL) {
  ## create formula dynamically
  formula <- as.formula(paste0(outcome, " ~ ", predictor))
  ## fit logistic regression
  model <- glm(formula, data = data, family = binomial(link = link))
  ## generate prediction grid
  x_vals <- seq(min(data[[predictor]], na.rm = TRUE),
                max(data[[predictor]], na.rm = TRUE),
                length.out = n_points)
  newdata <- data.frame(x = x_vals)
  names(newdata) <- predictor
  ## predict probabilities and standard errors
  preds <- predict(model, newdata = newdata, type = "link", se.fit = TRUE)
  ## transform logit predictions back to probability scale
  newdata$predicted_prob <- plogis(preds$fit)
  newdata$lower_ci <- plogis(preds$fit - 1.96 * preds$se.fit)
  newdata$upper_ci <- plogis(preds$fit + 1.96 * preds$se.fit)
  ## calculate thresholds
  threshold_points <- sapply(prob_thresholds, function(p) {
    index <- which.min(abs(newdata$predicted_prob - p))
    newdata[[predictor]][index]})
  ## plot with confidence interval shading
  p <- ggplot(newdata, aes_string(x = predictor, y = "predicted_prob")) +
    geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), fill = "darkorchid", alpha = 0.1) +
    geom_line(color = "darkorchid4", linewidth = 1.2) +
    scale_x_continuous(breaks = seq(0, 7, by = 1)) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    labs(#title = paste("Predicted Probability of", outcome, "vs", predictor),
      #title = paste("Predicted Probability of Transmission vs", predictor),
      #x = predictor, 
      x = paste("Airborne", xlabel, "Area Under the Curve of Days 1-3"),
      y = "Probability of Transmission (%)") +
    theme_minimal() +
    theme(axis.text.y = element_text(face = "bold", size = 12),
          #axis.title.y = element_blank(),
          #axis.title.y = element_text(face = "bold", size = 14),
          axis.text.x = element_text(face = "bold", size = 12),
          axis.title.x = element_text(face = "bold", size = 13))
  ## add threshold lines and annotations
  ## use different colors for each threshold. #colors must = #thresholds
  colors <- c("red3", "blue3")
  for (i in seq_along(prob_thresholds)) {
    p <- p +
      geom_hline(yintercept = prob_thresholds[i], linetype = "dotted", color = "gray50") +
      geom_vline(xintercept = threshold_points[i], linetype = "dashed", linewidth = 1, 
                 color = colors[i], alpha = 0.5) +
      annotate("text",
               x = threshold_points[i], y = prob_thresholds[i] - 0.02,
               label = paste0(predictor, " â‰ˆ ", round(threshold_points[i], 3)),
               hjust = -0.1, color = colors[i])}
  ## hard code the colors as red
  # for (i in seq_along(prob_thresholds)) {
  #   p <- p +
  #     geom_hline(yintercept = prob_thresholds[i], linetype = "dotted", color = "gray50") +
  #     geom_vline(xintercept = threshold_points[i], linetype = "dashed", linewidth = 1, color = "red", alpha = 0.5) +
  #     annotate("text",
  #              x = threshold_points[i], y = prob_thresholds[i] - 0.02,
  #              label = paste0(predictor, " â‰ˆ ", round(threshold_points[i], 3)),
  #              hjust = -0.1, color = "red3")}
  return(p)}


#plot_prob_threshold(data = data, outcome = "trans", predictor = "PFU")
plot_prob_threshold(data = data, outcome = "trans_cat", predictor = "PFU")
#plot_prob_threshold(data = data, outcome = "trans", predictor = "AUC_PFU")
plot_prob_threshold(data = data, outcome = "trans_cat", predictor = "AUC_PFU")
#plot_prob_threshold(data = data, outcome = "trans", predictor = "RNA")
plot_prob_threshold(data = data, outcome = "trans_cat", predictor = "RNA")
#plot_prob_threshold(data = data, outcome = "trans", predictor = "AUC_RNA")
plot_prob_threshold(data = data, outcome = "trans_cat", predictor = "AUC_RNA")

plot_prob_auc_pfu <- plot_prob_threshold(data = data, outcome = "trans_cat", 
                                         predictor = "AUC_PFU", xlabel = 'PFU')
plot_prob_auc_rna <- plot_prob_threshold(data = data, outcome = "trans_cat", 
                                         predictor = "AUC_RNA", xlabel = 'RNA')

## import the Excel Table > MS Paint PNG file
image <- figpatch::fig("//cdc.gov/adp/FCID_DVRD_2_FLU/PATHOGENESIS TEAM/1Joanna/Lab/AR/Figures/Figure_5C_table-heatmap.png")

## patchwork
plot_auc_probs <- ((plot_prob_auc_pfu / plot_prob_auc_rna) | image) + plot_annotation(tag_levels = 'a')

# ragg::agg_tiff(filename = "Figure_5_AUC_probabilities.tiff",
#                width = 8, height = 6, units = 'in', res = 600,
#                scaling = 1, compression = "lzw")
# plot(plot_auc_probs)
# invisible(dev.off())

########################################################################################
########################################################################################
### SUPPLEMENTARY FIGURES ###
########################################################################################
########################################################################################

### SUPPLEMENTARY FIGURE 1

## RNA line plots only
data_stats %>% 
  filter(Sample != 'NW') %>%
  ggplot(aes(x = day, color = Sample, fill = Sample)) +
  geom_ribbon(aes(group = Sample, ymin = mr - ser, ymax = mr + ser), 
              alpha = 0.2) +
  geom_point(aes(y = mr), size = 2, alpha = 1) +
  geom_line(aes(y = mr, group = Sample), size = 0.8, alpha = 1) +
  scale_fill_viridis_d(begin = 0.4, end = 0.8, labels = virus_sample_labels) +
  scale_color_viridis_d(begin = 0.4, end = 0.8, labels = virus_sample_labels) +
  facet_grid(~ Virus, labeller = virus_sample_labels) +
  theme_minimal() +
  theme(legend.position = 'bottom') +
  labs(x = 'Day Post-Inocluation',
       y = expression(log[10]~paste("RNA"))) #-> plot_air_lines_rna

## PFU line plots only
data_stats %>% 
  filter(Sample != 'NW') %>%
  ggplot(aes(x = day, color = Sample, fill = Sample)) +
  geom_ribbon(aes(group = Sample, ymin = mp - sep, ymax = mp + sep), 
              alpha = 0.2) +
  geom_point(aes(y = mp), size = 2, alpha = 1) +
  geom_line(aes(y = mp, group = Sample), size = 0.8, alpha = 1) +
  scale_fill_viridis_d(begin = 0.4, end = 0.8, labels = virus_sample_labels) +
  scale_color_viridis_d(begin = 0.4, end = 0.8, labels = virus_sample_labels) +
  facet_grid(~ Virus, labeller = virus_sample_labels) +
  theme_minimal() +
  theme(legend.position = 'none') +
  labs(x = 'Day Post-Inocluation',
       y = expression(log[10]~paste("PFU"))) #-> plot_air_lines_pfu


## combine plots
plot_lines <- plot_air_lines_pfu / plot_air_lines_rna + plot_annotation(tag_levels = 'a')

# ragg::agg_tiff(filename = "Figure_S1_air_lines_PFU-RNA.tiff",
#                width = 8, height = 6, units = 'in', res = 600,
#                scaling = 1, compression = "lzw")
# plot(plot_lines)
# invisible(dev.off())

########################################################################################

### SUPPLEMENTARY FIGURE 2

## NW v SPOT

## AUC PFU by transmissible
p_AUC_PFU_stat <- data_long %>% 
  select(Sample, Variable, Value, trans_3cat) %>%
  distinct() %>%
  filter(Sample != "NIOSH",
         Variable == "AUC_PFU") %>% 
  ggplot(aes(x = trans_3cat, y = Value, fill = trans_3cat, color = trans_3cat)) +
  geom_boxplot(alpha = 0.4) +
  geom_point() +
  geom_boxplot(alpha = 0.4) +
  facet_wrap(~ Sample, scales = "free_y", 
             labeller = as_labeller(c(NW = "Nasal Wash", NIOSH = "Air / BC 251", SPOT = "Air / SPOT"))) + 
  ## accurate Dunn test p-values
  ggpubr::geom_pwc(method = 'dunn_test', label = 'p.format', step.increase = 0.4) +
  ## overall Kruskal-Wallis stat
  # ggpubr::stat_kruskal_test(label = "p.format", label.y.npc = "bottom", 
  #                           label.x.npc = "center", hjust = 0.5,
  #                           size = 6, fontface = "bold") +
  ## not consistent with Dunn, Wilcox p-values
  # ggpubr::stat_compare_means(comparisons = list(c("High-transmissible", "Low-transmissible"),
  #                                               c("Non-transmissible", "Low-transmissible"),
  #                                               c("High-transmissible", "Non-transmissible")),
  #                            size = 6, step.increase = 0.5, label = "p.signif", method = "wilcox.test") +
  theme_void() +
  labs(y = expression("log"[10]*" Value")) +
  ylim(NA, max(data_long$Value) + 0.6) +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        strip.text = element_text(size = 15),
        #panel.background = element_rect(fill = 'white', color = 'white'),
        plot.background = element_rect(color = "black", size = 1, fill = 'white')) +
  scale_fill_viridis_d(begin = 0.2, end = 0.75, option = 'magma') +
  scale_color_viridis_d(begin = 0.2, end = 0.75, option = 'magma')

norm_data %>%
  group_by(Virus, ferret) %>%
  mutate(Sample2 = case_when(Sample == 'NW' ~ 'NW', 
                             Sample == 'NIOSH' ~ 'Air', 
                             Sample == 'SPOT' ~ 'Air'),
         occurrence = row_number()) %>%
  ungroup() %>%
  filter(Sample != 'NIOSH') %>%
  pivot_wider(names_from = Sample2, values_from = c(AUC_PFU, AUC_RNA),
              id_cols = c(Virus, day, ferret, trans_3cat)) %>%
  unnest(cols = everything()) %>% 
  distinct() %>%
  #subset(!(Virus %in% c("CA147", "CO137"))) %>%
  ggplot(aes(x = AUC_PFU_NW, y = AUC_PFU_Air, color = trans_3cat)) + 
  geom_smooth(method = 'lm', se = TRUE, color = "darkorchid4", 
              alpha = 0.2, linetype = 'dashed') +
  geom_point(size = 6, alpha = 0.9) +
  ggrepel::geom_text_repel(aes(label = Virus), size = 5, 
                           data = . %>% group_by(AUC_PFU_NW, AUC_PFU_Air) %>% slice(1)) +
  ggpubr::stat_cor(aes(x = AUC_PFU_NW, y = AUC_PFU_Air), method = "pearson", 
                   label.x.npc = "left", label.y.npc = 'top', size = 5) + 
  ggpubr::stat_cor(aes(x = AUC_PFU_NW, y = AUC_PFU_Air), method = "pearson", 
                   label.y.npc = 0.85, label.x.npc = 'left', size = 5, color = 'black') +
  #ggpp::stat_group_counts(label.x = 'right', label.y = 'top', vstep = 0.02) +
  #facet_grid(~ Virus, labeller = virus_sample_labels) +
  labs(title = 'a', 
       x = "Nasal Wash PFU Area Under the Curve of Days 1-3",
       y = "Airborne PFU Area Under the Curve of Days 1-3") +
  theme_bw() +
  theme(legend.position = 'bottom',
        axis.text = element_text(size = 14, face = "bold"),
        axis.title = element_text(size = 16, face = "bold"),
        legend.text = element_text(size = 14, face = "bold"),
        legend.title = element_blank()) +
  scale_color_viridis_d(begin = 0.2, end = 0.75, option = 'magma') +
  annotation_custom(ggplotGrob(p_AUC_PFU_stat), 
                    xmin = 7, xmax = Inf, ymin = -Inf, ymax = 0.45) #-> plot_cor_pfu_spot

# ragg::agg_tiff(filename = "Figure_correlation_NWvNIOSH_AUC_PFU.tiff",
#                width = 9, height = 11, units = 'in', res = 600, 
#                scaling = 1, compression = "lzw")
# plot(plot_cor_pfu)
# invisible(dev.off())

###

## AUC RNA by transmissible
p_AUC_RNA_stat <- data_long %>% 
  select(Sample, Variable, Value, trans_3cat) %>%
  distinct() %>%
  filter(Sample != "NIOSH", 
         Variable == "AUC_RNA") %>%
  ggplot(aes(x = trans_3cat, y = Value, fill = trans_3cat, color = trans_3cat)) +
  geom_boxplot(alpha = 0.4) +
  geom_point() +
  geom_boxplot(alpha = 0.4) +
  facet_wrap(~ Sample, scales = "free_y", 
             labeller = as_labeller(c(NW = "Nasal Wash", NIOSH = "Air / BC 251", SPOT = "Air / SPOT"))) + 
  ## accurate Dunn test p-values
  ggpubr::geom_pwc(method = 'dunn_test', label = 'p.format', step.increase = 0.2) +
  ## overall Kruskal-Wallis stat
  # ggpubr::stat_kruskal_test(label = "p.format", label.y.npc = "bottom", 
  #                           label.x.npc = "center", hjust = 0.5,
  #                           size = 6, fontface = "bold") +
  ## not consistent with Dunn, Wilcox p-values
  # ggpubr::stat_compare_means(comparisons = list(c("High-transmissible", "Low-transmissible"),
  #                                               c("Non-transmissible", "Low-transmissible"),
  #                                               c("High-transmissible", "Non-transmissible")), 
  #                            size = 6, step.increase = 0.16, label = "p.signif", method = "wilcox.test") +
  theme_void() +
  labs(y = expression("log"[10]*" Value")) +
  ylim(NA, max(data_long$Value) + 0.75) +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        strip.text = element_text(size = 15),
        #panel.background = element_rect(fill = 'white', color = 'white'),
        plot.background = element_rect(color = "black", size = 1, fill = 'white')) +
  scale_fill_viridis_d(begin = 0.2, end = 0.75, option = 'magma') +
  scale_color_viridis_d(begin = 0.2, end = 0.75, option = 'magma')


norm_data %>%
  group_by(Virus, ferret) %>%
  mutate(Sample2 = case_when(Sample == 'NW' ~ 'NW', 
                             Sample == 'NIOSH' ~ 'Air', 
                             Sample == 'SPOT' ~ 'Air'),
         occurrence = row_number()) %>%
  ungroup() %>%
  filter(Sample != 'NIOSH') %>%
  pivot_wider(names_from = Sample2, values_from = c(AUC_PFU, AUC_RNA),
              id_cols = c(Virus, day, ferret, trans_3cat)) %>%
  unnest(cols = everything()) %>% 
  distinct() %>% 
  #subset(!(Virus %in% c("CA147", "CO137", "MI90"))) %>%
  ggplot(aes(x = AUC_RNA_NW, y = AUC_RNA_Air, color = trans_3cat)) + 
  geom_smooth(method = 'lm', se = TRUE, color = "darkorchid4", 
              alpha = 0.2, linetype = 'dashed') +
  geom_point(size = 6, alpha = 0.9) +
  ggrepel::geom_text_repel(aes(label = Virus), size = 5, 
                           data = . %>% group_by(AUC_RNA_NW, AUC_RNA_Air) %>% slice(1)) +
  ggpubr::stat_cor(aes(x = AUC_RNA_NW, y = AUC_RNA_Air), method = "pearson", 
                   label.x.npc = "left", label.y.npc = 'top', size = 5) + 
  ggpubr::stat_cor(aes(x = AUC_RNA_NW, y = AUC_RNA_Air), method = "pearson", 
                   label.y.npc = 0.85, label.x.npc = 'left', size = 5, color = 'black') +
  #ggpp::stat_group_counts(label.x = 'right', label.y = 'top', vstep = 0.02) +
  #facet_grid(~ Virus, labeller = virus_sample_labels) +
  labs(title = 'b',
       x = "Nasal Wash RNA Area Under the Curve of Days 1-3",
       y = "Airborne RNA Area Under the Curve of Days 1-3") +
  theme_bw() +
  theme(legend.position = 'bottom',
        axis.text = element_text(size = 14, face = "bold"),
        axis.title = element_text(size = 16, face = "bold"),
        legend.text = element_text(size = 14, face = "bold"),
        legend.title = element_blank()) +
  scale_color_viridis_d(begin = 0.2, end = 0.8, option = 'magma') +
  annotation_custom(ggplotGrob(p_AUC_RNA_stat), 
                    xmin = 9.5, xmax = Inf, ymin = -Inf, ymax = 2.1) #-> plot_cor_rna_spot


## combine plots
p45 <- plot_cor_pfu_spot + plot_cor_rna_spot
# ragg::agg_tiff(filename = "Figure_S2_correlation_NWvSPOT_AUC_PFU-RNA.tiff",
#                width = 12, height = 11, units = 'in', res = 600,
#                scaling = 0.8, compression = "lzw")
# plot(p45)
# invisible(dev.off())

########################################################################################

### SUPPLEMENTARY FIGURE 3

### PFU/RNA by day

## NIOSH RNA
norm_data %>%
  filter(day != 'd5') %>%
  group_by(Virus, ferret) %>%
  mutate(Sample2 = case_when(Sample == 'NW' ~ 'NW', 
                             Sample == 'NIOSH' ~ 'Air', 
                             Sample == 'SPOT' ~ 'Air'),
         occurrence = row_number()) %>%
  ungroup() %>%
  filter(Sample != 'SPOT') %>%
  pivot_wider(names_from = Sample2, values_from = c(PFU, RNA),
              id_cols = c(Virus, day, ferret, trans_3cat)) %>%
  unnest(cols = everything()) %>% 
  distinct() %>% 
  ggplot(aes(x = RNA_NW, y = RNA_Air, color = trans_3cat)) +
  geom_smooth(method = 'lm', se = TRUE, color = "darkorchid4", 
              alpha = 0.2, linetype = 'dashed') +
  geom_point(size = 5, alpha = 0.8) +  
  # ggpubr::stat_cor(method = "pearson", 
  #                  label.x.npc = "center", label.y.npc = 'bottom') + 
  ggpubr::stat_cor(method = "pearson", size = 5,
                   label.x.npc = 'left', label.y.npc = 'top', color = 'black') +
  #ggpp::stat_group_counts(label.x = 'left', label.y = 'top', vstep = 0.02) +
  scale_fill_viridis_d(begin = 0.2, end = 0.8, option = 'magma', labels = virus_sample_labels) +
  scale_color_viridis_d(begin = 0.2, end = 0.8, option = 'magma', labels = virus_sample_labels) +
  scale_y_continuous(breaks = seq(0, 11, by = 1)) +
  labs(x = expression("log"[10]*" Nasal Wash RNA"),
       y = expression("log"[10]*" Air / BC 251 RNA")) +
  facet_grid(~ day, scales = 'free', labeller = virus_sample_labels) +
  theme_minimal() +
  theme(legend.title = element_blank(),
        legend.position = 'none', 
        axis.text = element_text(size = 14, face = "bold"),
        axis.title = element_text(size = 16, face = "bold"),
        legend.text = element_text(size = 14, face = "bold"),
        strip.text = element_text(size = 16, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(nrow = 1)) #-> plot_day_niosh_rna

## NIOSH PFU
norm_data %>%
  filter(day != 'd5') %>%
  group_by(Virus, ferret) %>%
  mutate(Sample2 = case_when(Sample == 'NW' ~ 'NW', 
                             Sample == 'NIOSH' ~ 'Air', 
                             Sample == 'SPOT' ~ 'Air'),
         occurrence = row_number()) %>%
  ungroup() %>%
  filter(Sample != 'SPOT') %>%
  pivot_wider(names_from = Sample2, values_from = c(PFU, RNA),
              id_cols = c(Virus, day, ferret, trans_3cat)) %>%
  unnest(cols = everything()) %>% 
  distinct() %>% 
  ggplot(aes(x = PFU_NW, y = PFU_Air, color = trans_3cat)) +
  geom_smooth(method = 'lm', se = TRUE, color = "darkorchid4", 
              alpha = 0.2, linetype = 'dashed') +
  geom_point(size = 5, alpha = 0.8) +  
  # ggpubr::stat_cor(method = "pearson", 
  #                  label.x.npc = "center", label.y.npc = 'bottom') + 
  ggpubr::stat_cor(method = "pearson", size = 5,
                   label.x.npc = 'left', label.y.npc = 'top', color = 'black') +
  #ggpp::stat_group_counts(label.x = 'left', label.y = 'top', vstep = 0.02) +
  scale_fill_viridis_d(begin = 0.2, end = 0.8, option = 'magma', labels = virus_sample_labels) +
  scale_color_viridis_d(begin = 0.2, end = 0.8, option = 'magma', labels = virus_sample_labels) +
  scale_y_continuous(breaks = seq(0, 11, by = 1)) +
  labs(x = expression("log"[10]*" Nasal Wash PFU"),
       y = expression("log"[10]*" Air / BC 251 PFU")) +
  facet_grid(~ day, scales = 'free', labeller = virus_sample_labels) +
  theme_minimal() +
  theme(legend.title = element_blank(),
        legend.position = 'none', 
        axis.text = element_text(size = 14, face = "bold"),
        axis.title = element_text(size = 16, face = "bold"),
        legend.text = element_text(size = 14, face = "bold"),
        strip.text = element_text(size = 16, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(nrow = 1)) #-> plot_day_niosh_pfu


## SPOT RNA
norm_data %>%
  filter(day != 'd5') %>%
  group_by(Virus, ferret) %>%
  mutate(Sample2 = case_when(Sample == 'NW' ~ 'NW', 
                             Sample == 'NIOSH' ~ 'Air', 
                             Sample == 'SPOT' ~ 'Air'),
         occurrence = row_number()) %>%
  ungroup() %>%
  filter(Sample != 'NIOSH') %>%
  pivot_wider(names_from = Sample2, values_from = c(PFU, RNA),
              id_cols = c(Virus, day, ferret, trans_3cat)) %>%
  unnest(cols = everything()) %>% 
  distinct() %>% 
  ggplot(aes(x = RNA_NW, y = RNA_Air, color = trans_3cat)) +
  geom_smooth(method = 'lm', se = TRUE, color = "darkorchid4", 
              alpha = 0.2, linetype = 'dashed') +
  geom_point(size = 5, alpha = 0.8) +  
  # ggpubr::stat_cor(method = "pearson", 
  #                  label.x.npc = "center", label.y.npc = 'bottom') + 
  ggpubr::stat_cor(method = "pearson", size = 5,
                   label.x.npc = 'left', label.y.npc = 'top', color = 'black') +
  #ggpp::stat_group_counts(label.x = 'left', label.y = 'top', vstep = 0.02) +
  scale_fill_viridis_d(begin = 0.2, end = 0.8, option = 'magma', labels = virus_sample_labels) +
  scale_color_viridis_d(begin = 0.2, end = 0.8, option = 'magma', labels = virus_sample_labels) +
  scale_y_continuous(breaks = seq(0, 11, by = 1)) +
  labs(x = expression("log"[10]*" Nasal Wash RNA"),
       y = expression("log"[10]*" Air / SPOT RNA")) +
  facet_grid(~ day, scales = 'free', labeller = virus_sample_labels) +
  theme_minimal() +
  theme(legend.title = element_blank(),
        legend.position = 'bottom', 
        axis.text = element_text(size = 14, face = "bold"),
        axis.title = element_text(size = 16, face = "bold"),
        legend.text = element_text(size = 14, face = "bold"),
        strip.text = element_text(size = 16, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(nrow = 1)) #-> plot_day_spot_rna

## SPOT PFU
norm_data %>%
  filter(day != 'd5') %>%
  group_by(Virus, ferret) %>%
  mutate(Sample2 = case_when(Sample == 'NW' ~ 'NW', 
                             Sample == 'NIOSH' ~ 'Air', 
                             Sample == 'SPOT' ~ 'Air'),
         occurrence = row_number()) %>%
  ungroup() %>%
  filter(Sample != 'NIOSH') %>%
  pivot_wider(names_from = Sample2, values_from = c(PFU, RNA),
              id_cols = c(Virus, day, ferret, trans_3cat)) %>%
  unnest(cols = everything()) %>% 
  distinct() %>% 
  ggplot(aes(x = PFU_NW, y = PFU_Air, color = trans_3cat)) +
  geom_smooth(method = 'lm', se = TRUE, color = "darkorchid4", 
              alpha = 0.2, linetype = 'dashed') +
  geom_point(size = 5, alpha = 0.8) +  
  # ggpubr::stat_cor(method = "pearson", 
  #                  label.x.npc = "center", label.y.npc = 'bottom') + 
  ggpubr::stat_cor(method = "pearson", size = 5,
                   label.x.npc = 'left', label.y.npc = 'top', color = 'black') +
  #ggpp::stat_group_counts(label.x = 'left', label.y = 'top', vstep = 0.02) +
  scale_fill_viridis_d(begin = 0.2, end = 0.8, option = 'magma', labels = virus_sample_labels) +
  scale_color_viridis_d(begin = 0.2, end = 0.8, option = 'magma', labels = virus_sample_labels) +
  scale_y_continuous(breaks = seq(0, 11, by = 1)) +
  labs(x = expression("log"[10]*" Nasal Wash PFU"),
       y = expression("log"[10]*" Air / SPOT PFU")) +
  facet_grid(~ day, scales = 'free', labeller = virus_sample_labels) +
  theme_minimal() +
  theme(legend.title = element_blank(),
        legend.position = 'none', 
        axis.text = element_text(size = 14, face = "bold"),
        axis.title = element_text(size = 16, face = "bold"),
        legend.text = element_text(size = 14, face = "bold"),
        strip.text = element_text(size = 16, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(nrow = 1)) #-> plot_day_spot_pfu

## combine plots
plots_day <- plot_day_niosh_pfu / plot_day_spot_pfu / plot_day_niosh_rna / plot_day_spot_rna

# ragg::agg_tiff(filename = "Figure_S3_correlation_day_NIOSHvSPOT_PFU-RNA.tiff",
#                width = 10, height = 12, units = 'in', res = 600,
#                scaling = 0.8, compression = "lzw")
# plot(plots_day)
# invisible(dev.off())

########################################################################################
########################################################################################
### STATISTICS ###
########################################################################################
########################################################################################

## check normality and homogeneity of variance assumptions
## RNA & PFU & AUC
norm_data %>% 
  filter(Sample != 'NW') %>% 
  pivot_longer(cols = c(RNA, PFU, AUC_RNA, AUC_PFU), 
               names_to = "Variable", 
               values_to = "Value") %>% 
  ## Kurskal-Wallis/Wilcox for all data aggregated
  #filter(Variable == "PFU") %>%           ## Kurskal-Wallis/Wilcox
  #filter(Variable == "RNA") %>%           ## Kurskal-Wallis/Wilcox
  perform_assumption_checks(group_vars = c("day", "Sample"), "Value") %>% View()


norm_data %>% 
  pivot_longer(cols = c(RNA, PFU, AUC_RNA, AUC_PFU), 
               names_to = "Variable", 
               values_to = "Value") %>% 
  ## Kurskal-Wallis/Wilcox for all data aggregated
  #filter(Variable == "PFU") %>%           ## Kurskal-Wallis/Wilcox
  #filter(Variable == "RNA") %>%           ## Kurskal-Wallis/Wilcox
  perform_assumption_checks(group_vars = c("day", "Sample", "trans_cat"), "Value") %>% View()

########################################################################################

## stats ratio between Sample
norm_data %>%
  select(Sample, ratio) %>%
  filter(ratio > 0) %>%
  distinct() %>%
  #group_by(Sample) %>%
  #kruskal.test(AUC_RNA ~ trans_cat, data = .)
  rstatix::dunn_test(ratio ~ Sample, data = ., p.adjust.method = "holm") %>%
  View()

########################################################################################

## stats between transmissible and non-transmissible viruses
norm_data %>%
  select(Sample, AUC_PFU, trans_cat) %>%
  distinct() %>%
  group_by(Sample) %>%
  #kruskal.test(AUC_PFU ~ trans_cat, data = .)
  rstatix::dunn_test(AUC_PFU ~ trans_cat, data = ., p.adjust.method = "holm") %>%
  View()

norm_data %>%
  select(Sample, AUC_RNA, trans_cat) %>%
  distinct() %>%
  group_by(Sample) %>%
  #kruskal.test(AUC_RNA ~ trans_cat, data = .)
  rstatix::dunn_test(AUC_RNA ~ trans_cat, data = ., p.adjust.method = "holm") %>%
  View()

norm_data %>%
  select(Sample, PFU, trans_cat) %>%
  distinct() %>%
  group_by(Sample) %>%
  #kruskal.test(AUC_PFU ~ trans_cat, data = .)
  rstatix::dunn_test(PFU ~ trans_cat, data = ., p.adjust.method = "holm") %>%
  View()

norm_data %>%
  select(Sample, RNA, trans_cat) %>%
  distinct() %>%
  group_by(Sample) %>%
  #kruskal.test(AUC_RNA ~ trans_cat, data = .)
  rstatix::dunn_test(RNA ~ trans_cat, data = ., p.adjust.method = "holm") %>%
  View()

norm_data %>%
  select(Sample, ratio, trans_cat) %>%
  distinct() %>%
  group_by(Sample) %>%
  #kruskal.test(AUC_RNA ~ trans_cat, data = .)
  rstatix::dunn_test(ratio ~ trans_cat, data = ., p.adjust.method = "holm") %>%
  View()

########################################################################################

## stats between high-transmissible, low-transmissible, non-transmissible viruses
## Supplementary Table 4

norm_data %>%
  select(Sample, AUC_PFU, trans_3cat) %>%
  distinct() %>%
  group_by(Sample) %>%
  #kruskal.test(AUC_PFU ~ trans_cat, data = .)
  rstatix::dunn_test(AUC_PFU ~ trans_3cat, data = ., p.adjust.method = "holm") %>%
  View()

norm_data %>%
  select(Sample, AUC_RNA, trans_3cat) %>%
  distinct() %>%
  group_by(Sample) %>%
  #kruskal.test(AUC_RNA ~ trans_cat, data = .)
  rstatix::dunn_test(AUC_RNA ~ trans_3cat, data = ., p.adjust.method = "holm") %>%
  View()

norm_data %>%
  select(Sample, PFU, trans_3cat) %>%
  distinct() %>%
  group_by(Sample) %>%
  #kruskal.test(AUC_PFU ~ trans_cat, data = .)
  rstatix::dunn_test(PFU ~ trans_3cat, data = ., p.adjust.method = "holm") %>%
  View()

norm_data %>%
  select(Sample, RNA, trans_3cat) %>%
  distinct() %>%
  group_by(Sample) %>%
  #kruskal.test(AUC_RNA ~ trans_cat, data = .)
  rstatix::dunn_test(RNA ~ trans_3cat, data = ., p.adjust.method = "holm") %>%
  View()

norm_data %>%
  select(Sample, ratio, trans_3cat) %>%
  distinct() %>%
  group_by(Sample) %>%
  #kruskal.test(AUC_RNA ~ trans_cat, data = .)
  rstatix::dunn_test(ratio ~ trans_3cat, data = ., p.adjust.method = "holm") %>%
  View()

########################################################################################

## stats between clade D1.1 and B3.13, all viruses
norm_data %>%
  select(Sample, AUC_PFU, clade) %>%
  filter(clade %in% c('D1.1', 'B3.13')) %>%
  #filter(Sample != 'NW') %>%
  distinct() %>%
  group_by(Sample) %>%
  #kruskal.test(AUC_PFU ~ trans_cat, data = .)
  rstatix::dunn_test(AUC_PFU ~ clade, data = ., p.adjust.method = "holm") %>%
  View()

norm_data %>%
  select(Sample, AUC_RNA, clade) %>%
  filter(clade %in% c('D1.1', 'B3.13')) %>%
  #filter(Sample != 'NW') %>%
  distinct() %>%
  group_by(Sample) %>%
  #kruskal.test(AUC_RNA ~ trans_cat, data = .)
  rstatix::dunn_test(AUC_RNA ~ clade, data = ., p.adjust.method = "holm") %>%
  View()

########################################################################################

## compare B3.13 vs D1.1 virus AUC levels, no MI/90

norm_data %>%
  subset(clade %in% c('D1.1', 'B3.13')) %>% 
  filter(Virus != 'MI/90', Sample == 'NIOSH') %>%
  select(clade, AUC_PFU, AUC_RNA) %>%
  distinct() %>%
  rstatix::wilcox_test(AUC_PFU ~ clade, data = .)

norm_data %>%
  subset(clade %in% c('D1.1', 'B3.13')) %>% 
  filter(Virus != 'MI/90', Sample == 'NIOSH') %>%
  select(clade, AUC_PFU, AUC_RNA) %>%
  distinct() %>%
  rstatix::wilcox_test(AUC_RNA ~ clade, data = .)

norm_data %>%
  subset(clade %in% c('D1.1', 'B3.13')) %>% 
  filter(Virus != 'MI/90', Sample == 'NIOSH') %>%
  select(clade, AUC_PFU, AUC_RNA) %>%
  group_by(clade) %>% 
  summarise(mean_AUC_PFU = mean(AUC_PFU, na.rm = TRUE),
            mean_AUC_RNA = mean(AUC_RNA, na.rm = TRUE)) 

########################################################################################

## Fisher's Exact tests
## Supplementary Table 3
norm_data$PFU_binary <- ifelse(norm_data$PFU > 0, "Detected", "Not Detected")
norm_data$RNA_binary <- ifelse(norm_data$RNA > 0, "Detected", "Not Detected")

table_data_PFU <- table(norm_data$Sample, norm_data$PFU_binary)
table_data_PFU

table_data_RNA <- table(norm_data$Sample, norm_data$RNA_binary)
table_data_RNA

fisher.test(table_data_PFU[c("NIOSH", "SPOT"), ])
## NIOSH samples are about 2 times more likely to have detected PFU compared to SPOT samples

fisher.test(table_data_RNA[c("NIOSH", "SPOT"), ])
## NIOSH samples are about 4.18 times more likely to have detected RNA compared to SPOT samples

########################################################################################

### 7 Oct 2025 revisions
### Repeated Measures Analysis

## prep data
norm_data2 <- norm_data %>%
  group_by(Virus, ferret) %>%
  filter(day != 'd5') %>%
  mutate(Sample2 = case_when(Sample == 'NW' ~ 'NW', 
                             Sample == 'NIOSH' ~ 'Air', 
                             Sample == 'SPOT' ~ 'Air'),
         day = factor(day),
         ## add small offset for 0 values
         PFU  = PFU + 0.001,
         RNA = RNA + 0.001,
         occurrence = row_number()) %>%
  ungroup() %>%
  filter(Sample != 'SPOT') %>%
  pivot_wider(names_from = Sample2, values_from = c(PFU, RNA),
              id_cols = c(Virus, day, ferret, trans_3cat)) %>%
  unnest(cols = everything()) %>% 
  distinct()

## mixed-effects models
m_intercept_p <- lme4::lmer(PFU_Air ~ PFU_NW * day + (1 | ferret),
                            data = norm_data2, REML = FALSE,
                            control = lme4::lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e5)))

m_intercept_r <- lme4::lmer(RNA_Air ~ RNA_NW * day + (1 | ferret),
                            data = norm_data2, REML = FALSE,
                            control = lme4::lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e5)))

# summary(m_intercept_p)
# ## check singularity - should be FALSE
# lme4::isSingular(m_intercept_p, tol = 1e-4)
# performance::check_model(m_intercept_p)
# broom.mixed::tidy(m_intercept_p, conf.int = TRUE)
# 
# summary(m_intercept_r)
# ## check singularity - should be FALSE
# lme4::isSingular(m_intercept_r, tol = 1e-4)
# performance::check_model(m_intercept_r)
# broom.mixed::tidy(m_intercept_r, conf.int = TRUE)

m_final_p <- update(m_intercept_p, REML = TRUE)
m_final_r <- update(m_intercept_r, REML = TRUE)

summary(m_final_p)
lme4::isSingular(m_final_p, tol = 1e-4)
performance::check_model(m_final_p)
broom.mixed::tidy(m_final_p, conf.int = TRUE)

summary(m_final_r)
lme4::isSingular(m_final_r, tol = 1e-4)
performance::check_model(m_final_r)
broom.mixed::tidy(m_final_r, conf.int = TRUE)

###

## simple slopes
em_p <- emmeans::emtrends(m_final_p, ~ day, var = "PFU_NW")
em_r <- emmeans::emtrends(m_final_r, ~ day, var = "RNA_NW")
summary(em_p)
summary(em_r)
## test whether slopes differ by day (pairwise comparisons)
pairs(em_p)
pairs(em_r)

###

## repeated measures correlation - to control for ferret variance
rmc_p <- rmcorr::rmcorr(participant = ferret, measure1 = PFU_NW, measure2 = PFU_Air, dataset = norm_data2)

rmc_r <- rmcorr::rmcorr(participant = ferret, measure1 = RNA_NW, measure2 = RNA_Air, dataset = norm_data2)

ggplot(norm_data2, aes(x = PFU_NW, y = PFU_Air, color = factor(ferret))) +
  rmcorr::geom_rmc(rmc_p) +
  facet_wrap(~Virus) +
  theme_bw()

ggplot(norm_data2, aes(x = RNA_NW, y = RNA_Air, color = factor(ferret))) +
  rmcorr::geom_rmc(rmc_r) +
  facet_wrap(~Virus) +
  theme_bw()

########################################################################################
########################################################################################
### End of used code
########################################################################################
########################################################################################



########################################################################################



########################################################################################
########################################################################################
### OTHER - UNSUED PLOTS & ANALYSES ###
########################################################################################
########################################################################################

## plot long data with pairwise stats - NIOSH v SPOT Ratio
data_long %>%
  #filter(Sample != 'NW') %>%
  #filter(day != 'd5') %>%
  filter(Value > 0) %>% 
  #subset(Variable %in% c('PFU', 'RNA', 'ratio')) %>%
  subset(Variable %in% 'ratio') %>%
  distinct() %>%
  ggplot(aes(x = Sample, y = Value, fill = Sample, color = Sample)) +
  geom_jitter(alpha = 0.8, width = 0.25) +
  geom_boxplot(alpha = 0.3, width = 0.2) +
  geom_violin(alpha = 0.2) +
  facet_grid(~ Variable,scales = "free_y", labeller = virus_sample_labels) +
  ## accurate Dunn test p-values
  ggpubr::geom_pwc(method = 'dunn_test', label = 'p.signif', hide.ns = FALSE) +
  # ggh4x::facet_nested(Variable ~ Virus + day, labeller = virus_sample_labels) +
  # ggpubr::geom_signif(comparisons = list(c("NIOSH", "SPOT"),
  #                                        c("NIOSH", "NW"),
  #                                        c("NW", "SPOT")),
  #                     test = "wilcox.test", na.rm = TRUE, step_increase = 0.1, size = 1) +
  # ggpubr::stat_kruskal_test(label = "p.format", label.y.npc = "bottom", 
  #                           label.x.npc = "center", hjust = 0.5,
  #                           size = 6, fontface = "bold") +
  # ggpubr::stat_compare_means(comparisons = list(c("NIOSH", "SPOT"),
  #                                               c("NIOSH", "NW"),
  #                                               c("NW", "SPOT")), 
  #                            size = 6, step.increase = 0.1, method = 'wilcox.test', label = 'p.signif') +
  labs(y = expression("log"[10]*" (RNA copies / PFU)")) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = 'bottom',
        legend.title = element_blank(), 
        panel.grid = element_blank(),
        strip.background = element_rect(fill = "grey95")) +
  scale_y_continuous(breaks = seq(0, 7, by = 1)) +
  scale_fill_viridis_d(begin = 0.2, end = 0.7, labels = virus_sample_labels) +
  scale_color_viridis_d(begin = 0.2, end = 0.7, labels = virus_sample_labels) #-> plot_ratio

# ragg::agg_tiff(filename = "Figure_NWvNIOSHvSPOT_Ratio.tiff",
#                width = 5, height = 6, units = 'in', res = 600, 
#                scaling = 1, compression = "lzw")
# plot(plot_ratio)
# invisible(dev.off())

###

## plot long data with pairwise stats - NIOSH v SPOT
data_long %>%
  filter(Sample != 'NW') %>%
  subset(Variable %in% c('PFU', 'RNA', 'ratio')) %>%
  filter(!(Variable == "ratio" & Value == 0)) %>%
  distinct() %>%
  mutate(Variable = fct_relevel(Variable, "RNA", "ratio", "PFU")) %>%
  ggplot(aes(x = Sample, y = Value, fill = Sample, color = Sample)) +
  geom_boxplot(alpha = 0.3) +
  geom_jitter() +
  #facet_grid(~ Variable,scales = "free_y") +
  ggh4x::facet_nested(Variable ~ Virus + day, labeller = virus_sample_labels, scales = "free_y") +
  ggpubr::geom_signif(comparisons = list(c("NIOSH", "SPOT")),
                      test = "wilcox.test", na.rm = TRUE) +
  labs(y = expression("log"[10]*" Value")) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = 'bottom',
        legend.title = element_blank(),
        strip.background = element_rect(fill = "grey95")) +
  scale_y_continuous(breaks = seq(0, 7, by = 1)) +
  scale_fill_viridis_d(begin = 0.2, end = 0.7, labels = virus_sample_labels) +
  scale_color_viridis_d(begin = 0.2, end = 0.7, labels = virus_sample_labels) #-> plot_pairwise

# ragg::agg_tiff(filename = "Figure_NIOSHvSPOT_pairwiseStats.tiff",
#                width = 14, height = 10, units = 'in', res = 600, 
#                scaling = 0.8, compression = "lzw")
# plot(plot_pairwise)
# invisible(dev.off())

########################################################################################

## Coefficient of Variation (CV) is (SD/Mean * 100) = %Variation
## Unit-less, standardized measure of relative variability between disparate groups
## Low variability: CV < 10%
## Moderate variability: CV = 10â€“50%
## High variability: CV > 50%
## Extreme variability: CV > 100% (meaning high data spread compared to the mean)

## plot Coefficients of Variation for PFU/RNA
data_stats %>%
  pivot_longer(cols = c(cvp, cvr), names_to = "Variable", values_to = "CV") %>%
  #pivot_longer(cols = c(rcvqp, rcvqr), names_to = "Variable", values_to = "CV") %>%
  #pivot_longer(cols = c(rcvmp, rcvmr), names_to = "Variable", values_to = "CV") %>%
  ggplot(aes(x = Sample, y = CV, fill = Variable))  +
  ## shade below 50% = low/moderate CV variability
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = 50, 
           fill = "green", alpha = 0.15) + 
  ## shade above 50% = high CV variability
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 50, ymax = 100, 
           fill = "orange", alpha = 0.15) +
  ## shade above 100% = extreme high CV variability
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 100, ymax = Inf, 
           fill = "red", alpha = 0.15) +
  geom_boxplot() +
  #geom_hline(yintercept = 50) +
  facet_wrap(~ Virus) +
  labs(y = "Coefficient of Variation (CV) as a Percentage") +
  scale_x_discrete(labels = c(NW = "Nasal Wash", 
                              NIOSH = "Air / BC 251", 
                              SPOT = "Air / SPOT")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank(),
        legend.title = element_blank(),
        legend.position = 'bottom',
        strip.background = element_rect(fill = "grey99"),
        strip.text = element_text(color = "black", face = "bold")) +
  scale_fill_viridis_d(begin = 0.4, end = 0.8, option = 'mako', 
                       labels = c(cvp = "PFU CV", cvr = "RNA CV")) #-> plot_cv

# ragg::agg_tiff(filename = "Figure_CoefficientOfVariation.tiff",
#                width = 6, height = 6, units = 'in', res = 600, 
#                scaling = 1, compression = "lzw")
# plot(plot_cv)
# invisible(dev.off())

########################################################################################

### Correlations

cor_matrix <- norm_data %>%
  select(PFU, RNA, ratio, 
         AUC_PFU, AUC_RNA, ratio_auc) %>%
  ## replace infinite values with NA
  #mutate(across(everything(), ~replace(., is.infinite(.), NA))) %>%
  ## calculate correlation
  cor(use = "pairwise.complete.obs")

pheatmap::pheatmap(cor_matrix,
                   display_numbers = TRUE,  ## show correlation values
                   number_format = "%.2f",  ## round to 2 decimal places
                   cluster_rows = FALSE,    ## optional: disable clustering
                   cluster_cols = FALSE)    ## optional: disable clustering
## PFU, RNA, and AUCs all highly correlated. 
## Ratio only moderately so.
## Ratio AUC not correlated, other than moderate with Ratio.

###

norm_data %>% #filter(Sample != 'NW') %>% 
  cor.test_analysis(data = ., xvars = "AUC_PFU", yvars = "AUC_RNA", 
                    group_var = c('Sample', 'Virus')) %>% View()

norm_data %>% 
  cor.test_analysis(data = ., xvars = "PFU", yvars = "RNA", 
                    group_var = c('Sample', 'Virus')) %>% View()

norm_data %>%
  select(AUC_PFU, AUC_RNA) %>%
  distinct() %>%
  cor.test_analysis(data = ., xvars = "AUC_PFU", yvars = "AUC_RNA")

norm_data %>%
  cor.test_analysis(data = ., xvars = "PFU", yvars = "RNA")

norm_data %>%
  select(Sample, AUC_PFU, AUC_RNA) %>%
  distinct() %>%
  cor.test_analysis(data = ., xvars = "AUC_PFU", yvars = "AUC_RNA", 
                    group_var = c('Sample')) %>% View()

norm_data %>% 
  cor.test_analysis(data = ., xvars = "PFU", yvars = "RNA", 
                    group_var = c('Sample')) %>% View()

########################################################################################

########################################################################################

## AUC by virus
norm_data %>%
  ggplot(aes(x = AUC_PFU, y = AUC_RNA, color = Virus)) +
  geom_smooth(method = 'lm', se = TRUE, color = "darkorchid4", 
              alpha = 0.2, linetype = 'dashed') +
  geom_point(size = 5, alpha = 0.8) +  
  ggpubr::stat_cor(aes(x = AUC_PFU, y = AUC_RNA), method = "pearson", 
                   label.x.npc = 0.65, label.y.npc = 'bottom') + 
  ggpubr::stat_cor(aes(x = AUC_PFU, y = AUC_RNA), method = "pearson", 
                   label.x.npc = 0.3, label.y.npc = 'bottom', color = 'black') +
  ggpp::stat_group_counts(label.x = 'left', label.y = 'bottom', 
                          vstep = 0.018, vjust = -1.7) +
  scale_fill_viridis_d(begin = 0.15, end = 0.85, option = "mako", labels = virus_sample_labels) +
  scale_color_viridis_d(begin = 0.15, end = 0.85, option = "mako", labels = virus_sample_labels) +
  scale_y_continuous(breaks = seq(0, 11, by = 1)) +
  labs(x = expression("log"[10]*" PFU Area Under the Curve (AUC)"),
       y = expression("log"[10]*" RNA Area Under the Curve (AUC)")) +
  facet_grid(~ Sample, scales = 'free', labeller = virus_sample_labels) +
  theme_minimal() +
  theme(legend.position = 'bottom',
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(nrow = 1)) #-> p6

###

## PFU/RNA by virus
norm_data %>%
  #filter(PFU != 0, RNA != 0) %>%
  ggplot(aes(x = PFU, y = RNA, color = Virus)) +
  geom_smooth(method = 'lm', se = TRUE, color = "darkorchid4", 
              alpha = 0.2, linetype = 'dashed') +
  geom_point(size = 5, alpha = 0.8) +  
  ggpubr::stat_cor(aes(x = PFU, y = RNA), method = "pearson", 
                   label.x.npc = "center", label.y.npc = 'bottom') + 
  ggpubr::stat_cor(aes(x = PFU, y = RNA), method = "pearson", 
                   label.x.npc = 0.15, label.y.npc = 'bottom', color = 'black') +
  ggpp::stat_group_counts(label.x = 'left', label.y = 'top', vstep = 0.02) +
  scale_fill_viridis_d(begin = 0.15, end = 0.85, option = "mako", labels = virus_sample_labels) +
  scale_color_viridis_d(begin = 0.15, end = 0.85, option = "mako", labels = virus_sample_labels) +
  scale_y_continuous(breaks = seq(0, 11, by = 1)) +
  labs(x = expression("Mean log"[10]*" PFU"),
       y = expression("Mean log"[10]*" RNA")) +
  facet_grid(~ Sample, scales = 'free', labeller = virus_sample_labels) +
  theme_minimal() +
  theme(legend.position = 'bottom', 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(nrow = 1)) #-> p5

########################################################################################

#scales::show_col(viridis::viridis(n = 25, option = 'mako'))

## RNA & PFU normalized on the sample plot
## Filter by Sample type for cleaner view
data_stats %>%
  filter(Sample == 'NW') %>%
  group_by(Virus) %>%
  mutate(mr_norm = mr - first(mr),
         mp_norm = mp - first(mp)) %>%
  ggplot(aes(x = day)) +
  geom_ribbon(aes(group = Sample, ymin = mr_norm - ser, ymax = mr_norm + ser), 
              alpha = 0.2, fill = '#38629DFF') +
  geom_ribbon(aes(group = Sample, ymin = mp_norm - sep, ymax = mp_norm + sep), 
              alpha = 0.2, fill = '#49C1ADFF') +
  geom_point(aes(y = mr_norm), size = 2, alpha = 1, color = '#38629DFF') +
  geom_point(aes(y = mp_norm), size = 2, alpha = 1, shape = 25, color = '#49C1ADFF', fill = '#49C1ADFF') +
  geom_line(aes(y = mr_norm, group = Sample), size = 0.8, alpha = 1, color = '#38629DFF') +
  geom_line(aes(y = mp_norm, group = Sample), size = 0.8, alpha = 1, color = '#49C1ADFF', linetype = 'dotted') +
  geom_hline(yintercept = 0, linetype = 'dashed', color = 'red') +
  facet_grid(~ Virus, labeller = virus_sample_labels) +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = 'Nasal Wash (NW)',
       x = 'Day of Collection') #-> plot_rna_pfu_norm_nw

data_stats %>%
  filter(Sample == 'NIOSH') %>%
  group_by(Virus) %>%
  mutate(mr_norm = mr - first(mr),
         mp_norm = mp - first(mp)) %>%
  ggplot(aes(x = day)) +
  geom_ribbon(aes(group = Sample, ymin = mr_norm - ser, ymax = mr_norm + ser), 
              alpha = 0.2, fill = '#38629DFF') +
  geom_ribbon(aes(group = Sample, ymin = mp_norm - sep, ymax = mp_norm + sep), 
              alpha = 0.2, fill = '#49C1ADFF') +
  geom_point(aes(y = mr_norm), size = 2, alpha = 1, color = '#38629DFF') +
  geom_point(aes(y = mp_norm), size = 2, alpha = 1, shape = 25, color = '#49C1ADFF', fill = '#49C1ADFF') +
  geom_line(aes(y = mr_norm, group = Sample), size = 0.8, alpha = 1, color = '#38629DFF') +
  geom_line(aes(y = mp_norm, group = Sample), size = 0.8, alpha = 1, color = '#49C1ADFF', linetype = 'dotted') +
  geom_hline(yintercept = 0, linetype = 'dashed', color = 'red') +
  facet_grid(~ Virus, labeller = virus_sample_labels) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  labs(title = 'Air / BC 251',
       x = 'Day of Collection',
       y = 'Mean RNA & PFU with Standard Error - Normalized Starting Point') #-> plot_rna_pfu_norm_niosh

data_stats %>%
  filter(Sample == 'SPOT') %>%
  group_by(Virus) %>%
  mutate(mr_norm = mr - first(mr),
         mp_norm = mp - first(mp)) %>%
  ggplot(aes(x = day)) +
  geom_ribbon(aes(group = Sample, ymin = mr_norm - ser, ymax = mr_norm + ser), 
              alpha = 0.2, fill = '#38629DFF') +
  geom_ribbon(aes(group = Sample, ymin = mp_norm - sep, ymax = mp_norm + sep), 
              alpha = 0.2, fill = '#49C1ADFF') +
  geom_point(aes(y = mr_norm), size = 2, alpha = 1, color = '#38629DFF') +
  geom_point(aes(y = mp_norm), size = 2, alpha = 1, shape = 25, color = '#49C1ADFF', fill = '#49C1ADFF') +
  geom_line(aes(y = mr_norm, group = Sample), size = 0.8, alpha = 1, color = '#38629DFF') +
  geom_line(aes(y = mp_norm, group = Sample), size = 0.8, alpha = 1, color = '#49C1ADFF', linetype = 'dotted') +
  geom_hline(yintercept = 0, linetype = 'dashed', color = 'red') +
  facet_grid(~ Virus, labeller = virus_sample_labels) +
  theme_minimal() +
  theme(axis.title.y = element_blank()) +
  labs(title = 'Air / SPOT',
       x = 'Day of Collection') #-> plot_rna_pfu_norm_spot


## combined plots
# plots_pfu_rna_normalized <- plot_rna_pfu_norm_nw / plot_rna_pfu_norm_niosh / plot_rna_pfu_norm_spot
# 
# ragg::agg_tiff(filename = "Figure_pfu_rna_normalized.tiff",
#                width = 8, height = 8, units = 'in', res = 600, 
#                scaling = 1, compression = "lzw")
# plot(plots_pfu_rna_normalized)
# invisible(dev.off())

########################################################################################

### Ratios

norm_data %>%
  filter(ratio > 0) %>%
  ggplot(aes(x = Sample, y = ratio, color = trans_3cat, shape = trans_3cat)) + 
  geom_jitter(size = 3, alpha = 0.3, width = 0.1) +
  facet_grid(~ day, labeller = virus_sample_labels) +
  scale_x_discrete(labels = c(NW = "Nasal Wash", 
                              NIOSH = "Air / BC 251", 
                              SPOT = "Air / SPOT")) +
  labs(y = "Ratio of RNA / PFU") +
  scale_color_viridis_d(begin = 0.2, end = 0.8, option = 'magma', labels = virus_sample_labels,
                        guide = guide_legend(override.aes = list(size = 6, alpha = 1))) +
  scale_shape_manual(values = c(17, 15, 16), labels = virus_sample_labels) +
  ggpp::stat_centroid(aes(x = Sample, y = ratio, shape = trans_3cat), size = 8, alpha = 0.7) +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text = element_text(size = 14, face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title = element_text(size = 16, face = "bold"),
        legend.text = element_text(size = 14, face = "bold"),
        legend.position = 'bottom',
        legend.title = element_blank(),
        strip.background = element_rect(fill = "grey99"),
        strip.text = element_text(size = 14, color = "black", face = "bold")) #-> plot_ratios

# ragg::agg_tiff(filename = "Figure_ratios.tiff",
#                width = 8, height = 6, units = 'in', res = 600, 
#                scaling = 1, compression = "lzw")
# plot(plot_ratios)
# invisible(dev.off())

########################################################################################

data <- norm_data %>% filter(Sample == 'NIOSH') %>%
  mutate(trans_cat = as.factor(trans_cat))

# data <- norm_data %>% filter(Sample == 'NIOSH') %>%
#   mutate(trans_cat = as.factor(trans_cat)) %>%
#   filter(Virus %in% c('NE/14', 'VN/1203'))

###

### ROC Thresholds

roc_pfu <- pROC::roc(data$trans_cat, data$PFU, quiet = TRUE)
coords_pfu <- pROC::coords(roc_pfu, "best", ret = "threshold", best.method = "youden")
coords_pfu
## 1.04406 optimal PFU threshold

roc_pauc <- pROC::roc(data$trans_cat, data$AUC_PFU, quiet = TRUE)
coords_pauc <- pROC::coords(roc_pauc, "best", ret = "threshold", best.method = "youden")
coords_pauc
## 1.261331 optimal AUC_PFU threshold

roc_rna <- pROC::roc(data$trans_cat, data$RNA, quiet = TRUE)
coords_rna <- pROC::coords(roc_rna, "best", ret = "threshold", best.method = "youden")
coords_rna
## 3.905662 optimal RNA threshold

roc_rauc <- pROC::roc(data$trans_cat, data$AUC_RNA, quiet = TRUE)
coords_rauc <- pROC::coords(roc_rauc, "best", ret = "threshold", best.method = "youden")
coords_rauc
## 4.316703 optimal AUC_RNA threshold

## convert to dataframes
coords_pfu <- as.data.frame(pROC::coords(roc_pfu, "best", ret = c("threshold", "specificity", "sensitivity")))
coords_pauc <- as.data.frame(pROC::coords(roc_pauc, "best", ret = c("threshold", "specificity", "sensitivity")))
coords_rna <- as.data.frame(pROC::coords(roc_rna, "best", ret = c("threshold", "specificity", "sensitivity")))
coords_rauc <- as.data.frame(pROC::coords(roc_rauc, "best", ret = c("threshold", "specificity", "sensitivity")))

#scales::show_col(viridis::viridis(n = 25, option = 'mako'))

ggplot() +
  geom_line(data = data.frame(tpr = roc_pfu$sensitivities, fpr = 1 - roc_pfu$specificities), 
            aes(x = fpr, y = tpr), color = "#49C1ADFF", linewidth = 1.2) +
  geom_line(data = data.frame(tpr = roc_pauc$sensitivities, fpr = 1 - roc_pauc$specificities), 
            aes(x = fpr, y = tpr), color = "#49C1ADFF", linewidth = 1.2, linetype = 'dashed') +
  geom_line(data = data.frame(tpr = roc_rna$sensitivities, fpr = 1 - roc_rna$specificities), 
            aes(x = fpr, y = tpr), color = "#38629DFF", linewidth = 1.2) +
  geom_line(data = data.frame(tpr = roc_rauc$sensitivities, fpr = 1 - roc_rauc$specificities), 
            aes(x = fpr, y = tpr), color = "#38629DFF", linewidth = 1.2, linetype = 'dashed') +
  geom_point(aes(x = 1 - coords_pfu$specificity, y = coords_pfu$sensitivity), color = "#49C1ADFF", size = 6) +
  geom_point(aes(x = 1 - coords_pauc$specificity, y = coords_pauc$sensitivity), color = "#49C1ADFF", size = 6) +
  geom_point(aes(x = 1 - coords_rna$specificity, y = coords_rna$sensitivity), color = "#38629DFF", size = 6) +
  geom_point(aes(x = 1 - coords_rauc$specificity, y = coords_rauc$sensitivity), color = "#38629DFF", size = 6) +
  labs(title = "ROC Curves for PFU, AUC_PFU, RNA, and AUC_RNA",
       x = "False Positive Rate (1 - Specificity)",
       y = "True Positive Rate (Sensitivity)") +
  theme_minimal()

###

### Decision Trees

tree_model <- rpart::rpart(trans_3cat ~ PFU + RNA + AUC_PFU + AUC_RNA, data = data, method = "class")
tree_model
## node),   split,       n, loss,     yval,               (yprob)         * denotes terminal node
## 1)               root 184 86 non-transmissible (0.53260870 0.46739130)  
## 2)  AUC_PFU< 1.261331 84  0  non-transmissible (1.00000000 0.00000000) *
## 3)  AUC_PFU>=1.261331 100 14 transmissible     (0.14000000 0.86000000)  
## 6)  AUC_PFU< 1.645695 14  6  transmissible     (0.42857143 0.57142857) *
## 7)  AUC_PFU>=1.645695 86  8  transmissible     (0.09302326 0.90697674)  
## 14) AUC_PFU>=2.197522 30  8  transmissible     (0.26666667 0.73333333)  
## 28) AUC_PFU< 2.305558  8  0  non-transmissible (1.00000000 0.00000000) *
## 29) AUC_PFU>=2.305558 22  0  transmissible     (0.00000000 1.00000000) *
## 15) AUC_PFU< 2.197522 56  0  transmissible     (0.00000000 1.00000000) *
# 
## Below 1.26 = very unlikely transmission
## Between 1.26 and 2.2 = mostly transmissible, some ambiguity
## Above 2.3 = very likely transmissible

rpart.plot::rpart.plot(tree_model, type = 2, extra = 106, fallen.leaves = TRUE,
                       box.palette = "BuGn", tweak = 1.2, main = "Transmission Classification Tree")

rpart.plot::rpart.rules(tree_model)
## 0.00 when AUC_PFU <  1.3       
## 0.57 when AUC_PFU is 1.3 to 1.6
## 1.00 when AUC_PFU is 1.6 to 2.2
## 0.00 when AUC_PFU is 2.2 to 2.3
## 1.00 when AUC_PFU >=        2.3

##          trans_3cat  High Low- Non-  
## Non-transmissible  [ .00  .00 1.00] when AUC_PFU <  1.3  
## Low-transmissible  [ .00 1.00  .00] when AUC_PFU is 1.3 to 2.1 & AUC_RNA <  5.7       
## High-transmissible [ .86  .00  .14] when AUC_PFU >= 1.3 & AUC_RNA >= 5.7
## Non-transmissible  [ .00  .00 1.00] when AUC_PFU >= 2.1 & AUC_RNA <  5.7

tree_model$variable.importance
##  AUC_PFU  AUC_RNA      RNA      PFU 
## 84.75155 74.21987 43.58755 39.51943 
## 82.83011 82.51164 42.78449 36.88664 


tree_model <- rpart::rpart(trans_3cat ~ AUC_PFU, data = data, method = "class")
tree_model
rpart.plot::rpart.rules(tree_model)
##          trans_3cat  High Low- Non-                            
## Non-transmissible  [ .00  .00 1.00] when AUC_PFU <  1.3   
## Low-transmissible  [ .00  .57  .43] when AUC_PFU is 1.3 to 1.6
## Low-transmissible  [ .00 1.00  .00] when AUC_PFU is 1.6 to 1.8
## High-transmissible [1.00  .00  .00] when AUC_PFU is 1.8 to 1.8
## Low-transmissible  [ .00 1.00  .00] when AUC_PFU is 1.8 to 2.1
## High-transmissible [ .79  .00  .21] when AUC_PFU >=        2.1


tree_model <- rpart::rpart(trans_3cat ~ PFU + RNA + AUC_RNA, data = data, method = "class")
tree_model
rpart.plot::rpart.rules(tree_model)
## 0.00 when AUC_RNA <  4.3   
## 0.81 when AUC_RNA is 4.3 to 5.4 & PFU <  1
## 0.91 when AUC_RNA >=        4.3 & PFU >= 1
## 0.35 when AUC_RNA >=        5.4 & PFU <  1

##          trans_3cat  High Low- Non-                            
## Non-transmissible  [ .00  .00 1.00] when AUC_RNA <  4.3 
## Low-transmissible  [ .00  .87  .13] when AUC_RNA is 4.3 to 5.4
## Non-transmissible  [ .00  .44  .56] when AUC_RNA is 5.4 to 5.7
## High-transmissible [ .86  .00  .14] when AUC_RNA >=        5.7


tree_model <- rpart::rpart(trans_3cat ~ PFU + RNA, data = data, method = "class")
tree_model
rpart.plot::rpart.rules(tree_model)
## 0.24 when PFU <  0.50         & RNA is 3.4 to 4.7
## 0.71 when PFU is 0.50 to 0.77 & RNA is 3.4 to 4.7
## 0.10 when PFU is 0.77 to 1.04 & RNA is 3.4 to 4.7
## 0.13 when PFU <  1.04         & RNA <  3.4       
## 0.67 when PFU <  1.04         & RNA >=        4.7
## 0.82 when PFU >=         1.04

##         trans_3cat  Hig Low Non                                              
## Low-transmissible  [.00 .71 .29] when PFU is 0.50 to 0.77 & RNA is 3.4 to 4.7
## Non-transmissible  [.00 .24 .76] when PFU <  0.50         & RNA is 3.4 to 4.7
## Non-transmissible  [.00 .10 .90] when PFU is 0.77 to 1.04 & RNA is 3.4 to 4.7
## Non-transmissible  [.00 .13 .87] when PFU <  1.04         & RNA <  3.4   
## Low-transmissible  [.22 .44 .33] when PFU <  1.04         & RNA >=        4.7
## High-transmissible [.78 .11 .11] when PFU is 1.04 to 1.53 & RNA is 4.8 to 6.0
## Low-transmissible  [.00 .55 .45] when PFU >=         1.04 & RNA <  3.9  
## High-transmissible [.71 .18 .12] when PFU >=         1.04 & RNA is 3.9 to 4.5
## Low-transmissible  [.10 .70 .20] when PFU >=         1.04 & RNA is 4.5 to 4.8
## High-transmissible [.85 .00 .15] when PFU >=         1.04 & RNA >=        6.0
## Low-transmissible  [.42 .50 .08] when PFU >=         1.53 & RNA is 4.8 to 6.0


tree_model <- rpart::rpart(trans_3cat ~ PFU, data = data, method = "class")
tree_model
rpart.plot::rpart.rules(tree_model)
## 0.20 when PFU <  0.46        
## 0.56 when PFU is 0.46 to 0.74
## 0.14 when PFU is 0.74 to 1.04
## 0.82 when PFU >=         1.04

##         trans_3cat  Hig Low Non  
## Non-transmissible  [.02 .22 .76] when PFU <  1.0 
## Low-transmissible  [.33 .42 .25] when PFU is 1.0 to 1.2
## High-transmissible [.62 .12 .25] when PFU is 1.2 to 1.3
## Low-transmissible  [.22 .50 .28] when PFU is 1.3 to 1.6
## High-transmissible [.68 .24 .09] when PFU >=        1.6


tree_model <- rpart::rpart(trans_3cat ~ RNA, data = data, method = "class")
tree_model
rpart.plot::rpart.rules(tree_model)
## 0.23 when RNA <  3.9  
## 0.67 when RNA is 3.9 to 4.3
## 0.29 when RNA is 4.3 to 4.4
## 0.85 when RNA is 4.4 to 4.6
## 0.43 when RNA is 4.6 to 4.7
## 0.84 when RNA >=        4.7

##        trans_3cat  Hig Low Non 
## Non-transmissible  [.00 .23 .77] when RNA <  3.9     
## High-transmissible [.40 .27 .33] when RNA is 3.9 to 4.3
## Non-transmissible  [.14 .14 .71] when RNA is 4.3 to 4.4
## High-transmissible [.71 .29 .00] when RNA is 4.4 to 4.5
## Low-transmissible  [.06 .56 .38] when RNA is 4.5 to 4.8
## High-transmissible [.57 .33 .10] when RNA is 4.8 to 5.5
## Low-transmissible  [.14 .43 .43] when RNA is 5.5 to 5.9
## High-transmissible [.86 .00 .14] when RNA >=        5.9


tree_model <- rpart::rpart(trans_3cat ~ ratio, data = data, method = "class")
tree_model
rpart.plot::rpart.rules(tree_model)
## 0.23 when ratio <  2.3  
## 1.00 when ratio is 2.3 to 2.5
## 0.44 when ratio is 2.5 to 2.7
## 0.67 when ratio is 2.7 to 2.8
## 0.27 when ratio is 2.8 to 3.1
## 0.77 when ratio is 3.1 to 3.7
## 0.38 when ratio is 3.7 to 3.9
## 0.64 when ratio >=        3.9

trans_3cat  Hig Low Non                          
## Non-transmissible  [.12 .25 .62] when ratio is 3.7 to 3.9
## Non-transmissible  [.01 .22 .77] when ratio <  2.3 
## High-transmissible [.50 .50 .00] when ratio is 2.3 to 2.5
## Non-transmissible  [.17 .29 .54] when ratio is 2.5 to 3.2
## Low-transmissible  [.31 .46 .23] when ratio is 3.2 to 3.5
## High-transmissible [.54 .31 .15] when ratio is 3.5 to 3.7
## High-transmissible [.41 .24 .35] when ratio is 3.9 to 4.5
## High-transmissible [.64 .00 .36] when ratio >=        4.5

########################################################################################
########################################################################################





########################################################################################
########################################################################################

### Ordination

library(vegan)

data <- norm_data %>% filter(Sample == 'NIOSH')

### NMDS

## prep data
## select numerical variables for analysis
norm_vars <- data[, c("PFU", "RNA", "AUC_PFU", "AUC_RNA")]
#norm_vars <- data[, c("AUC_PFU", "AUC_RNA")]

## standardize the data (optional, useful for distance metrics)
norm_vars_scaled <- scale(norm_vars)

## compute a distance matrix (Bray-Curtis is common for ecological data)
dist_matrix <- vegdist(norm_vars_scaled, method = "bray")

## run NMDS (k = 2 for two dimensions)
nmds_result <- metaMDS(dist_matrix, k = 3, trymax = 100)
nmds_result
## k = 2: 0.2312336 means a moderate fitâ€”patterns are likely meaningful but not perfectly captured.
## k = 3: 0.1699777

## Stress below 0.1 is excellent fit.
## Between 0.1-0.2 is good fit.
## Between 0.2-0.3 is a moderate fit, suggests some distortion.
## Above 0.3 is a poor fit, unreliable ordination

stressplot(nmds_result)
## k = 2: Non-metric Fit RÂ² of 0.947 is excellentâ€”it suggests NMDS effectively maintains the relative ordering of sample distances.
## k = 2: Linear Fit RÂ² of 0.779 is decent but suggests some distortion in absolute distances, but less crucial metric.
## k = 3: Non-metric Fit RÂ² of 0.971
## k = 3: Linear Fit RÂ² of 0.832

## plot NMDS
nmds_df <- as.data.frame(nmds_result$points) %>%
  mutate(Group = data$trans_3cat)  ## add grouping factor

ggplot(nmds_df, aes(x = MDS1, y = MDS2, color = Group)) +
  geom_point(size = 5, alpha = 0.8) +
  stat_ellipse(linewidth = 1.2, linetype = 'dashed') +
  theme_minimal() +
  theme(legend.position = 'bottom',
        legend.title = element_blank()) +
  labs(title = "NMDS Plot", x = "NMDS Dimension 1", y = "NMDS Dimension 2") +
  scale_color_viridis_d(begin = 0.2, end = 0.75, option = 'magma') #-> plot_nmds_all

# nmds_result <- metaMDS(dist_matrix, k = 3, trymax = 100, distance = 'manhattan')
# nmds_result
## similar results to bray

###

## ANOSIM 
anosim_result <- anosim(dist_matrix, grouping = data$trans_3cat, permutations = 999)
summary(anosim_result)
## ANOSIM statistic R: 0.3207 = weak to moderate separation, some structure
## Significance: 0.001 

## define two groups to compare
subset_data <- subset(data, trans_3cat %in% c("High-transmissible", "Low-transmissible"))
#subset_data <- subset(data, trans_3cat %in% c("High-transmissible", "Non-transmissible"))
#subset_data <- subset(data, trans_3cat %in% c("Low-transmissible", "Non-transmissible"))
numeric_columns <- c("PFU", "RNA", "AUC_PFU", "AUC_RNA")
subset_dist <- vegdist(subset_data[, numeric_columns], method = "bray")

## ANOSIM for these two groups
anosim_result_subset <- anosim(subset_dist, grouping = subset_data$trans_3cat, permutations = 999)
summary(anosim_result_subset)
## High v Low = ANOSIM statistic R: 0.4828, Significance: 0.001 
## High v Non = ANOSIM statistic R: 0.4421, Significance: 0.001 
## Low v Non  = ANOSIM statistic R: 0.2576, Significance: 0.001 
## all        = ANOSIM statistic R: 0.3207, Significance: 0.001 

###

### PLS

## prepare data (X = predictors, Y = classification variable)
X <- data[, c("PFU", "RNA", "AUC_PFU", "AUC_RNA")] ## 0.909  0.473  0.442  0.327
#X <- data[, c("PFU", "RNA")]                       ## 1      0.218  0.196 0.412
#X <- data[, c("AUC_PFU", "AUC_RNA")]               ## 1      0.443  0.444 0.334
#X <- data[, c("ratio", "ratio_auc")]               ## 0.668  0.11   0.106 0.439
Y <- as.factor(data$trans_3cat)

## PLS-DA
opls_model <- ropls::opls(X, Y)
opls_model
## RÂ²X (cum) = 0.913 = This indicates that 91.3% of variance in predictors (PFU, RNA, AUC, etc.) is explained by the model.
## RÂ²Y (cum) = 0.487 = The model explains 48.7% of variance in the response variable (transmissibility categories).
## This suggests a moderate relationship between viral metrics and transmissibility.
# 
## QÂ² (cum) = 0.47 â†’ This is the predictive ability of the model, showing how well it generalizes.
## A QÂ² close to RÂ²Y suggests good model stability.
# 
## RMSEE = 0.333 â†’ The Root Mean Squared Error of Estimation (RMSEE) indicates the typical prediction error.
## Lower values indicate better model accuracy; 0.333 suggests reasonable but not perfect prediction.

#plot(opls_model)

## extract sample scores from OPLS-DA model
scores_df <- as.data.frame(opls_model@scoreMN)
colnames(scores_df) <- c("OPLS1", "OPLS2")
scores_df$Group <- as.factor(Y)


ggplot(scores_df, aes(x = OPLS1, y = OPLS2, color = Group)) +
  geom_point(size = 5, alpha = 0.8) +
  stat_ellipse(linewidth = 1.2, linetype = 'dashed') +
  theme_minimal() +
  theme(legend.position = 'bottom',
        legend.title = element_blank()) +
  labs(title = "PLS-DA Score Plot", 
       x = "PLS Variable 1", 
       y = "PLS Variable 2") +
  scale_color_viridis_d(begin = 0.2, end = 0.75, option = 'magma') #]-> plot_pls_all

plots_nmds_pls <- 
  (plot_nmds_all + plot_pls_all) /
  (plot_nmds_auc + plot_pls_auc) +
  plot_annotation(tag_levels = 'A')

# ragg::agg_tiff(filename = "Figure_NIOSH_nmds_pls.tiff",
#                width = 8, height = 8, units = 'in', res = 600, 
#                scaling = 0.8, compression = "lzw")
# plot(plots_nmds_pls)
# invisible(dev.off())

########################################################################################

### create categorical bins and plot

data <- norm_data %>% filter(Sample == 'NIOSH')

## find bins
Hmisc::describe(funModeling::equal_freq(data$AUC_RNA, n_bins = 4))
## [2.84,3.75) [3.75,4.57) [4.57,5.80) [5.80,6.84]
#quantile(data$AUC_RNA, probs = 0.25) 
Hmisc::describe(funModeling::equal_freq(data$AUC_PFU, n_bins = 4))
## [-0.186,0.555) [ 0.555,1.524) [ 1.524,2.046) [ 2.046,2.615]
Hmisc::describe(funModeling::equal_freq(data$RNA, n_bins = 4))
## [0.00,3.26) [3.26,3.86) [3.86,4.71) [4.71,7.11]
Hmisc::describe(funModeling::equal_freq(data$PFU, n_bins = 4))
## 0.000 [0.115,0.717) [0.717,1.496) [1.496,2.806]

## create new bin columns

## All data
# data <- norm_data %>% 
#   mutate(AUC_RNA_bin = case_when(AUC_RNA < 3.755 ~ 'none',
#                                  AUC_RNA < 5.055 ~ 'Low',
#                                  AUC_RNA < 8.525 ~ 'Med',
#                                  AUC_RNA < 10.67 ~ 'High'),
#          AUC_PFU_bin = case_when(AUC_PFU < 0.4635 ~ 'none',
#                                  AUC_PFU < 1.6785 ~ 'Low',
#                                  AUC_PFU < 5.2905 ~ 'Med',
#                                  AUC_PFU < 8.037 ~ 'High'),
#          RNA_bin = case_when(RNA < 3.295 ~ 'none',
#                              RNA < 4.285 ~ 'Low',
#                              RNA < 7.085 ~ 'Med',
#                              RNA < 10.87 ~ 'High'),
#          PFU_bin = case_when(PFU == 0 ~ 'none',
#                              PFU < 1.1065 ~ 'Low',
#                              PFU < 4.2795 ~ 'Med',
#                              PFU < 8.080 ~ 'High'))

## NIOSH data only
data <- data %>% 
  mutate(AUC_RNA_bin = case_when(AUC_RNA < 3.755 ~ 'none',
                                 AUC_RNA < 4.575 ~ 'Low',
                                 AUC_RNA < 5.805 ~ 'Med',
                                 AUC_RNA < 6.85 ~ 'High'),
         AUC_PFU_bin = case_when(AUC_PFU < 0.5555 ~ 'none',
                                 AUC_PFU < 1.5245 ~ 'Low',
                                 AUC_PFU < 2.0465 ~ 'Med',
                                 AUC_PFU < 2.616 ~ 'High'),
         RNA_bin = case_when(RNA < 3.265 ~ 'none',
                             RNA < 3.865 ~ 'Low',
                             RNA < 4.715 ~ 'Med',
                             RNA < 7.12 ~ 'High'),
         PFU_bin = case_when(PFU < 0.1155 ~ 'none',
                             PFU < 0.7175 ~ 'Low',
                             PFU < 1.4965 ~ 'Med',
                             PFU < 2.807 ~ 'High'))

## reorder levels
data$AUC_PFU_bin <- factor(data$AUC_PFU_bin, levels = c("High", "Med", "Low", "none"))
data$AUC_RNA_bin <- factor(data$AUC_RNA_bin, levels = c("High", "Med", "Low", "none"))
data$PFU_bin <- factor(data$PFU_bin, levels = c("High", "Med", "Low", "none"))
data$RNA_bin <- factor(data$RNA_bin, levels = c("High", "Med", "Low", "none"))

###

## plot proportion of bins within each transmission category

ggplot(data, aes(x = trans_3cat, fill = AUC_PFU_bin)) +
  geom_bar(position = "fill") + 
  scale_y_continuous(labels = scales::percent_format()) + 
  scale_fill_viridis_d(begin = 0.15, end = 0.95, option = 'mako') +
  labs(title = "AUC PFU",
       y = "Proportion") +
  theme_minimal() +
  theme(legend.position = 'bottom',
        legend.title = element_blank(),
        axis.title.x = element_blank()) #-> plot_bin_auc_pfu

ggplot(data, aes(x = trans_3cat, fill = AUC_RNA_bin)) +
  geom_bar(position = "fill") + 
  scale_y_continuous(labels = scales::percent_format()) + 
  scale_fill_viridis_d(begin = 0.15, end = 0.95, option = 'mako') +
  labs(title = "AUC RNA",
       y = "Proportion") +
  theme_minimal() +
  theme(legend.position = 'bottom',
        legend.title = element_blank(),
        axis.title.x = element_blank()) #-> plot_bin_auc_rna

ggplot(data, aes(x = trans_3cat, fill = PFU_bin)) +
  geom_bar(position = "fill") + 
  scale_y_continuous(labels = scales::percent_format()) + 
  scale_fill_viridis_d(begin = 0.15, end = 0.95, option = 'mako') +
  labs(title = "PFU",
       y = "Proportion") +
  theme_minimal() +
  theme(legend.position = 'none',
        legend.title = element_blank(),
        axis.title.x = element_blank()) #-> plot_bin_pfu

ggplot(data, aes(x = trans_3cat, fill = RNA_bin)) +
  geom_bar(position = "fill") + 
  scale_y_continuous(labels = scales::percent_format()) + 
  scale_fill_viridis_d(begin = 0.15, end = 0.95, option = 'mako') +
  labs(title = "RNA",
       y = "Proportion") +
  theme_minimal() +
  theme(legend.position = 'none',
        legend.title = element_blank(),
        axis.title.x = element_blank()) #-> plot_bin_rna

## combine plots
plots_bin <- (plot_bin_pfu + plot_bin_rna) /
  (plot_bin_auc_pfu + plot_bin_auc_rna) +
  plot_annotation(tag_levels = 'A')

# ragg::agg_tiff(filename = "Figure_proportional_bins_NIOSH.tiff",
#                width = 6, height = 4, units = 'in', res = 600, 
#                scaling = 0.7, compression = "lzw")
# plot(plots_bin)
# invisible(dev.off())

########################################################################################

### STATISTICS

## PFU
norm_data %>%
  group_by(Sample) %>%
  #kruskal.test(AUC_PFU ~ Virus_day, data = .)
  rstatix::dunn_test(AUC_PFU ~ Virus, data = ., p.adjust.method = "holm") %>%
  View()

norm_data %>%
  group_by(Sample) %>%
  mutate(Virus_day = interaction(Virus, day)) %>% 
  #kruskal.test(AUC_PFU_log ~ Virus_day, data = .)
  rstatix::dunn_test(PFU ~ Virus_day, data = ., p.adjust.method = "holm") %>%
  View()

norm_data %>%
  group_by(trans_cat) %>%
  #kruskal.test(AUC_PFU_log ~ Virus_day, data = .)
  rstatix::dunn_test(AUC_PFU ~ Virus, data = ., p.adjust.method = "holm") %>%
  View()


## RNA
norm_data %>%
  group_by(Sample) %>%
  #kruskal.test(AUC_PFU ~ Virus_day, data = .)
  rstatix::dunn_test(AUC_RNA ~ Virus, data = ., p.adjust.method = "holm") %>%
  View()

norm_data %>%
  group_by(Sample) %>%
  mutate(Virus_day = interaction(Virus, day)) %>% 
  #kruskal.test(AUC_PFU_log ~ Virus_day, data = .)
  rstatix::dunn_test(RNA ~ Virus_day, data = ., p.adjust.method = "holm") %>%
  View()

norm_data %>%
  group_by(trans_cat) %>%
  #kruskal.test(AUC_PFU_log ~ Virus_day, data = .)
  rstatix::dunn_test(AUC_RNA ~ Virus, data = ., p.adjust.method = "holm") %>%
  View()

###

## Kruskal Wallis test
norm_data %>% 
  filter(Sample != 'NW', sample_time != '60min') %>% 
  filter(day != 'd4') %>%
  ## SPOT sampler normalized to NIOSH
  pivot_longer(cols = c(RNA, PFU), names_to = "Variable", values_to = "Value") %>%
  group_by(Virus, day, Variable) %>%
  group_split() %>%
  map_df(~ {
    test_result <- kruskal.test(Value ~ Sample, data = .)
    tibble(
      Virus = unique(.$Virus),
      day = unique(.$day),
      #Sample = unique(.$Sample),
      Variable = unique(.$Variable),
      N = length(.$Sample), 
      Statistic = test_result$statistic, ## test statistic
      DF = test_result$parameter,        ## degrees of freedom
      P_Value = test_result$p.value      ## p-value
    )}) %>% mutate(P_Adj = p.adjust(P_Value, method = "fdr")) %>% View()
  #write.csv(file = "R_outputs/NIOSH_v_SPOT_KruskalStats_SPOTnormalized.csv") 

norm_data %>% 
  filter(Sample != 'NW', sample_time != '60min') %>% 
  filter(day != 'd4') %>%
  ## SPOT sampler normalized to NIOSH
  pivot_longer(cols = c(AUC_RNA, AUC_PFU), names_to = "Variable", values_to = "Value") %>%
  group_by(Virus, day, Variable) %>%
  group_split() %>%
  map_df(~ {
    test_result <- kruskal.test(Value ~ Sample, data = .)
    tibble(
      Virus = unique(.$Virus),
      day = unique(.$day),
      #Sample = unique(.$Sample),
      Variable = unique(.$Variable),
      N = length(.$Sample), 
      Statistic = test_result$statistic, ## test statistic
      DF = test_result$parameter,        ## degrees of freedom
      P_Value = test_result$p.value      ## p-value
    )}) %>% mutate(P_Adj = p.adjust(P_Value, method = "fdr")) %>% View()
  #write.csv(file = "R_outputs/NIOSH_v_SPOT_AUC_KruskalStats_SPOTnormalized.csv")

###

## plot with Wilcox test stats - pairwise
## SPOT sampler normalized to NIOSH
norm_data %>% 
  filter(Sample != 'NW', sample_time != '60min') %>% 
  filter(day != 'd4') %>%
  pivot_longer(cols = c(RNA, PFU), names_to = "Variable", values_to = "Value") %>%
  ggplot(aes(x = Sample, y = Value, fill = Sample)) +
  geom_boxplot() +
  #facet_wrap(day ~ Variable, scales = "free_y") +
  facet_grid(Virus ~ day + Variable, labeller = virus_sample_labels) +
  labs(title = "Comparison of Samplers",
       x = "Sampler") +
  theme_minimal() +
  theme(legend.position = "none") +
  ggsignif::geom_signif(comparisons = list(c("SPOT", "NIOSH")), 
                        test = "wilcox.test", na.rm = TRUE, y_position = 6.3) +
  scale_fill_viridis_d(begin = 0.2, end = 0.7, labels = virus_sample_labels) #-> p1

#ggsave(plot = p1, file = "pairwise_stat_plot_NIOSHvSPOT_day.jpeg", width = 8, height = 10, units = "in")

## Kruskal-Wallis
data_long %>%
  subset(!grepl("^AUC", Variable)) %>%
  filter(Sample != 'NW') %>%
  group_by(Virus, day, Variable) %>%
  summarise(pvalue = kruskal.test(Value ~ Sample)$p.value) %>%
  mutate(p_adj_bonf = p.adjust(pvalue, method = "bonferroni"),
         p_adj_holm = p.adjust(pvalue, method = "holm")) %>% View()

data_long %>%
  subset(grepl("^AUC", Variable)) %>%
  filter(Sample != 'NW') %>%
  group_by(Virus, Variable) %>%
  summarise(pvalue = kruskal.test(Value ~ Sample)$p.value) %>%
  mutate(p_adj_bonf = p.adjust(pvalue, method = "bonferroni"),
         p_adj_holm = p.adjust(pvalue, method = "holm")) %>% View()

########################################################################################

## ratio plot to combine violin with barplot

p1_violin_ratio <- data_long %>%
  #filter(Sample != 'NW') %>%
  #filter(day != 'd5') %>%
  filter(Value > 0) %>% 
  #subset(Variable %in% c('PFU', 'RNA', 'ratio')) %>%
  subset(Variable %in% 'ratio') %>%
  distinct() %>%
  ggplot(aes(x = Sample, y = Value, fill = Sample, color = Sample)) +
  geom_jitter(alpha = 0.8, width = 0.25) +
  geom_boxplot(alpha = 0.3, width = 0.2) +
  geom_violin(alpha = 0.2) +
  facet_grid(~ Variable,scales = "free_y", labeller = virus_sample_labels) +
  ## this also works
  ggpubr::geom_pwc(method = 'dunn_test', label = 'p.format') +
  # ggpubr::stat_compare_means(comparisons = list(c("NIOSH", "SPOT"),
  #                                               c("NIOSH", "NW"),
  #                                               c("NW", "SPOT")),
  #                            size = 6, step.increase = 0.1, method = 'wilcox.test', label = 'p.signif') +
  labs(y = expression("log"[10]*" (RNA copies / PFU)")) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(face = "bold", size = 14),
        axis.title.y = element_text(face = "bold", size = 16),
        axis.title.x = element_blank(),
        legend.position = 'bottom',
        legend.text = element_text(size = 14, face = "bold"),
        legend.title = element_blank(), 
        panel.grid = element_blank(),
        strip.text = element_text(size = 14, face = "bold"),
        strip.background = element_rect(fill = "grey95")) +
  scale_y_continuous(breaks = seq(0, 7, by = 1)) +
  scale_fill_viridis_d(begin = 0.2, end = 0.7, labels = virus_sample_labels) +
  scale_color_viridis_d(begin = 0.2, end = 0.7, labels = virus_sample_labels)


p2_bar_ratio <- norm_data %>%
  pivot_longer(
    cols = c(ratio),
    names_to = "Variable",
    values_to = "Value") %>%
  group_by(Virus, Sample, Variable) %>%
  mutate(meanValue = mean(Value)) %>%
  ungroup() %>%
  mutate(#Virus = fct_reorder(factor(Virus), as.numeric(clade)),
    Variable = factor(Variable, levels = c("RNA", "ratio", "PFU"))) %>%
  ggplot(aes(x = Sample, y = meanValue, fill = Virus)) +
  geom_col(position = "dodge") +
  ## overall mean, no zeros
  geom_hline(aes(yintercept = ifelse(Variable == "ratio", 3.07, NA)), 
             linetype = "dashed", color = "red") +
  ## overall median, no zeros
  geom_hline(aes(yintercept = ifelse(Variable == "ratio", 2.98, NA)), 
             linetype = "dashed", color = "blue") +
  facet_grid(~Variable, labeller = as_labeller(c("PFU" = "PFU", 
                                                 "RNA" = "RNA", 
                                                 "ratio" = "Ratio (RNA copies / PFU)"))) +
  labs(y = expression("log"[10]*" (RNA copies / PFU)")) +
  geom_text(aes(label = Subtype, y = min(meanValue) - 0.55), #fontface = "bold",
            position = position_dodge(0.9), angle = 90, vjust = 0.3, hjust = 0.3, size = 5, color = 'darkorchid4') +
  scale_fill_viridis_d(begin = 0.15, end = 0.85, option = 'mako', labels = virus_sample_labels) +
  scale_y_continuous(breaks = seq(0, 10, by = 1)) +
  scale_x_discrete(labels = virus_sample_labels) +
  theme_minimal() +
  theme(legend.position = 'bottom', nrow = 1,
        legend.text = element_text(size = 14, face = "bold"),
        legend.title = element_blank(),
        strip.text = element_blank(),
        #strip.text = element_text(face = "bold", size = 14),
        axis.title.y = element_text(face = "bold", size = 16),
        axis.title.x = element_blank(),
        axis.text.y = element_text(face = "bold", size = 14),
        axis.text.x = element_text(face = "bold", size = 14, hjust = 0.5)) +
  guides(fill = guide_legend(nrow = 1))

# p_ratio_bar_violin <- (p1_violin_ratio / p2_bar_ratio) + plot_layout(heights = c(1, 0.8))
# 
# ragg::agg_tiff(filename = "Figure_NWvNIOSHvSPOT_Ratio_bar_violin.tiff",
#                width = 5, height = 6, units = 'in', res = 600, 
#                scaling = 0.5, compression = "lzw")
# plot(p_ratio_bar_violin)
# invisible(dev.off())

########################################################################################

## plot PFU by RNA
norm_data %>%
  ggplot(aes(x = PFU, y = RNA, color = Sample, shape = Sample)) + 
  geom_point(size = 3, alpha = 0.4) +
  facet_grid(Virus ~ day, labeller = virus_sample_labels) +
  theme_bw() +
  theme(legend.position = 'bottom') +
  scale_color_viridis_d(end = 0.8, labels = virus_sample_labels) +
  scale_shape_manual(values = c(16, 17, 18), labels = virus_sample_labels) +
  ggpp::stat_centroid(aes(x = PFU, y = RNA), shape = 18, size = 8, alpha = 0.7) +
  ggpp::stat_group_counts(label.x = 'right', label.y = 'bottom', vstep = 0.15) #-> p2

norm_data %>%
  ggplot(aes(x = PFU, y = RNA, color = Sample, shape = Sample)) + 
  geom_point(size = 3, alpha = 0.9) +
  facet_grid(~ day, labeller = virus_sample_labels) +
  theme_bw() +
  theme(legend.position = 'bottom') +
  scale_color_viridis_d(end = 0.8, labels = virus_sample_labels) +
  scale_shape_manual(values = c(16, 17, 18), labels = virus_sample_labels) +
  ggpp::stat_centroid(aes(x = PFU, y = RNA), shape = 18, size = 8, alpha = 0.6) +
  ggpp::stat_group_counts(label.x = 'left') #-> p3

norm_data %>%
  ggplot(aes(x = PFU, y = RNA, color = Sample, shape = Sample)) + 
  geom_point(size = 3, alpha = 0.9) +
  facet_grid(~ Virus, labeller = virus_sample_labels) +
  theme_bw() +
  theme(legend.position = 'bottom') +
  scale_color_viridis_d(end = 0.8, labels = virus_sample_labels) +
  scale_shape_manual(values = c(16, 17, 18), labels = virus_sample_labels) +
  ggpp::stat_centroid(aes(x = PFU, y = RNA), shape = 18, size = 8, alpha = 0.6) +
  ggpp::stat_group_counts(label.x = 'left') #-> p4

########################################################################################

### Correlations

## correlations by groups
norm_data %>%
  group_by(Virus, day, Sample) %>%
  summarise(
    cor = cor(PFU, RNA, use = "complete.obs"),
    cor_auc = cor(AUC_PFU, AUC_RNA, use = "complete.obs")) %>% View()

norm_data %>% filter(Sample != 'NW') %>% 
  cor.test_analysis(data = ., xvars = "PFU", yvars = "RNA", 
                    group_var = c('day', 'Virus')) %>% View()

norm_data %>% filter(Sample == 'NW') %>% 
  cor.test_analysis(data = ., xvars = "AUC_PFU", yvars = "AUC_RNA", 
                    group_var = c('Virus', 'clade')) %>% View()

## plot correlation coefficients
## PFU & RNA
set.seed(1234)
norm_data %>%
  group_by(Virus, day, Sample) %>%
  #group_by(day, Sample) %>%
  summarise(cor = cor(PFU, RNA, use = "complete.obs")) %>% 
  ggplot() +
  geom_jitter(aes(x = day, y = cor, color = Sample),
              size = 5, alpha = 0.7, width = 0.15) +
  geom_hline(yintercept = c(0.5, -0.5), linetype = 'dotted', color = 'red') +
  facet_wrap(~Virus, labeller = virus_sample_labels) +
  labs(x = 'Day of Collection',
       y = 'Correlation Coeffecient') +
  theme_bw() +
  theme(legend.position = 'bottom') +
  scale_color_viridis_d(end = 0.8, labels = virus_sample_labels) +
  scale_fill_viridis_d(end = 0.8, labels = virus_sample_labels)

## AUC
set.seed(123)
norm_data %>%
  group_by(Virus, day, Sample) %>%
  #group_by(day, Sample) %>%
  summarise(cor = cor(AUC_PFU, AUC_RNA, use = "complete.obs")) %>% 
  ggplot() +
  geom_jitter(aes(x = day, y = cor, color = Sample),
              size = 5, alpha = 0.7, width = 0.15) +
  geom_hline(yintercept = c(0.5, -0.5), linetype = 'dotted', color = 'red') +
  facet_wrap(~Virus, labeller = virus_sample_labels) +
  labs(x = 'Day of Collection',
       y = 'Correlation Coeffecient') +
  theme_bw() +
  theme(legend.position = 'bottom') +
  scale_color_viridis_d(end = 0.8, labels = virus_sample_labels) +
  scale_fill_viridis_d(end = 0.8, labels = virus_sample_labels)

########################################################################################

### Ratios

## plot the RNA/PFU ratios
norm_data %>%
  filter(ratio != 0) %>%
  ggplot() +
  geom_jitter(aes(x = day, y = ratio, color = Sample),
              size = 5, alpha = 0.7, width = 0.15) +
  geom_hline(yintercept = 0, color = 'red') +
  facet_wrap(~Virus, labeller = virus_sample_labels) +
  labs(x = 'Day of Collection',
       y = 'Ratio (RNA/PFU)') +
  theme_bw() +
  theme(legend.position = 'bottom') +
  scale_color_viridis_d(end = 0.8, labels = virus_sample_labels) +
  scale_fill_viridis_d(end = 0.8, labels = virus_sample_labels)

## plot the AUC RNA/PFU ratios
norm_data %>%
  filter(ratio_auc != 0) %>%
  ggplot() +
  geom_jitter(aes(x = day, y = ratio_auc, color = Sample),
              size = 5, alpha = 0.7, width = 0.15) +
  geom_hline(yintercept = 0, color = 'red') +
  facet_wrap(~Virus, , labeller = virus_sample_labels) +
  labs(x = 'Day of Collection',
       y = 'Ratio (RNA/PFU)') +
  theme_bw() +
  theme(legend.position = 'bottom') +
  scale_color_viridis_d(end = 0.8, labels = virus_sample_labels) +
  scale_fill_viridis_d(end = 0.8, labels = virus_sample_labels)

########################################################################################

## normalize the starting points
## RNA
data_stats %>%
  group_by(Sample, Virus) %>%
  mutate(mr_norm = mr - first(mr)) %>%
  ggplot(aes(x = day, color = Sample, fill = Sample)) +
  geom_ribbon(aes(group = Sample, ymin = mr_norm - ser, ymax = mr_norm + ser), 
              alpha = 0.2) +
  geom_point(aes(y = mr_norm), size = 2, alpha = 1) +
  geom_line(aes(y = mr_norm, group = Sample), size = 0.8, alpha = 1) +
  geom_hline(yintercept = 0, linetype = 'dashed', color = 'red') +
  scale_fill_viridis_d(end = 0.8, labels = virus_sample_labels) +
  scale_color_viridis_d(end = 0.8, labels = virus_sample_labels) +
  facet_grid(~ Virus, labeller = virus_sample_labels) +
  theme_minimal() +
  theme(legend.position = 'bottom') +
  labs(x = 'Day of Collection',
       y = 'Mean RNA with Standard Error - Normalized Starting Point') #-> p8

## PFU
data_stats %>%
  group_by(Sample, Virus) %>%
  mutate(mp_norm = mp - first(mp)) %>%
  ggplot(aes(x = day, color = Sample, fill = Sample)) +
  geom_ribbon(aes(group = Sample, ymin = mp_norm - sep, ymax = mp_norm + sep), 
              alpha = 0.2) +
  geom_point(aes(y = mp_norm), size = 2, alpha = 1) +
  geom_line(aes(y = mp_norm, group = Sample), size = 0.8, alpha = 1) +
  geom_hline(yintercept = 0, linetype = 'dashed', color = 'red') +
  scale_fill_viridis_d(end = 0.8, labels = virus_sample_labels) +
  scale_color_viridis_d(end = 0.8, labels = virus_sample_labels) +
  facet_grid(~ Virus, labeller = virus_sample_labels) +
  theme_minimal() +
  theme(legend.position = 'bottom') +
  labs(x = 'Day of Collection',
       y = 'Mean PFU with Standard Error - Normalized Starting Point') #-> p9

########################################################################################

### Means barplots

norm_data %>%
  filter(ratio > 0) %>%
  pivot_longer(
    cols = c(ratio),
    names_to = "Variable",
    values_to = "Value") %>% 
  filter(Variable == 'ratio') %>% 
  mutate(across(where(is.numeric), 
                ~ ifelse(is.nan(.) | is.na(.) | is.infinite(.), 0, .))) %>%
  summarise(mean_ratio = mean(Value, na.rm = TRUE),
            median_ratio = median(Value, na.rm = TRUE))

norm_data %>%
  pivot_longer(
    cols = c(PFU, RNA, ratio),
    names_to = "Variable",
    values_to = "Value") %>%
  group_by(Virus, Sample, Variable) %>%
  mutate(meanValue = mean(Value)) %>%
  ungroup() %>%
  mutate(#Virus = fct_reorder(factor(Virus), as.numeric(clade)),
         Variable = factor(Variable, levels = c("RNA", "ratio", "PFU"))) %>%
  ggplot(aes(x = Sample, y = meanValue, fill = Virus)) +
  geom_col(position = "dodge") +
  ## overall mean, no zeros
  geom_hline(aes(yintercept = ifelse(Variable == "ratio", 3.07, NA)), 
             linetype = "dashed", color = "red") +
  ## overall median, no zeros
  geom_hline(aes(yintercept = ifelse(Variable == "ratio", 2.98, NA)), 
             linetype = "dashed", color = "blue") +
  facet_grid(~Variable, labeller = as_labeller(c("PFU" = "PFU", 
                                                 "RNA" = "RNA", 
                                                 "ratio" = "Ratio RNA / PFU"))) +
  labs(y = expression("Mean log"[10]*" Virus Amount")) +
  geom_text(aes(label = Subtype, y = min(meanValue) - 0.55), #fontface = "bold",
            position = position_dodge(0.9), hjust = 0.5, size = 4, color = 'darkorchid4') +
  # geom_text(aes(label = Virus, y = -1.5), #fontface = "bold",
  #           position = position_dodge(0.9), hjust = 0.5, size = 3.5, color = 'blue4') +
  scale_fill_viridis_d(begin = 0.15, end = 0.85, option = 'mako', labels = virus_sample_labels) +
  scale_y_continuous(breaks = seq(0, 10, by = 1)) +
  scale_x_discrete(labels = virus_sample_labels) +
  theme_minimal() +
  theme(legend.position = 'bottom', nrow = 1,
        strip.text = element_text(face = "bold"),
        axis.title.x = element_text(face = "bold"),
        axis.title.y = element_blank(),
        axis.text.x = element_text(face = "bold"),
        axis.text.y = element_text(face = "bold", angle = 90, hjust = 0.5)) +
  guides(fill = guide_legend(nrow = 1)) +
  coord_flip() #-> p11

## AUC plots

norm_data %>%
  pivot_longer(
    cols = c(AUC_PFU, AUC_RNA, ratio_auc),
    names_to = "Variable",
    values_to = "Value") %>% 
  filter(Variable == 'ratio_auc') %>% 
  mutate(across(where(is.numeric), 
                ~ ifelse(is.nan(.) | is.na(.) | is.infinite(.), 0, .))) %>%
  summarise(mean_ratio_auc = mean(Value, na.rm = TRUE),
            median_ratio_auc = median(Value, na.rm = TRUE))

norm_data %>%
  pivot_longer(
    cols = c(AUC_PFU, AUC_RNA, ratio_auc),
    names_to = "Variable",
    values_to = "Value") %>%
  group_by(Virus, Sample, Variable) %>%
  mutate(meanValue = mean(Value)) %>%
  ungroup() %>%
  mutate(#Virus = fct_reorder(factor(Virus), as.numeric(clade)),
         Variable = factor(Variable, levels = c("AUC_RNA", "ratio_auc", "AUC_PFU"))) %>%
  ggplot(aes(x = Sample, y = meanValue, fill = Virus)) +
  geom_col(position = "dodge") +
  geom_hline(aes(yintercept = ifelse(Variable == "ratio_auc", 3.07, NA)), 
             linetype = "dashed", color = "red") +
  geom_hline(aes(yintercept = ifelse(Variable == "ratio_auc", 2.96, NA)), 
             linetype = "dashed", color = "blue") +
  facet_grid(~Variable, labeller = as_labeller(c("AUC_PFU" = "PFU", 
                                                 "AUC_RNA" = "RNA", 
                                                 "ratio_auc" = "Ratio RNA / PFU"))) +
  labs(y = expression("Mean log"[10]*" Area Under the Curve (AUC)")) +
  geom_text(aes(label = Subtype, y = min(meanValue) - 0.55), #fontface = "bold",
            position = position_dodge(0.9), hjust = 0.5, size = 4, color = 'darkorchid4') +
  scale_fill_viridis_d(begin = 0.15, end = 0.85, option = 'mako', labels = virus_sample_labels) +
  scale_y_continuous(breaks = seq(0, 10, by = 1)) +
  scale_x_discrete(labels = virus_sample_labels) +
  theme_minimal() +
  theme(legend.position = 'bottom', nrow = 1,
        strip.text = element_text(face = "bold"),
        axis.title.x = element_text(face = "bold"),
        axis.title.y = element_blank(),
        axis.text.x = element_text(face = "bold"),
        axis.text.y = element_text(face = "bold", angle = 90, hjust = 0.5)) +
  guides(fill = guide_legend(nrow = 1)) +
  coord_flip() #-> p12

########################################################################################
########################################################################################

### Statistical Models

norm_data %>%
  filter(Sample != 'NW') %>%
  lme4::lmer(AUC_PFU ~ trans_cat + 
               (1|ferret) + (1|Virus) + (1|clade), data = .) %>% 
  #report::report()
  summary()

## Binary transmission
## Conditional RÂ² = 0.65 = The full model explains 65% of the variance in AUC_PFU.
## Marginal RÂ² = 0.27 = The fixed effect (trans_cat) alone explains 27% of the variance.
## 
## The estimated baseline (Intercept) is 0.66, meaning that for non-transmissible viruses, the expected AUC_PFU is around 0.66.
## 95% CI [0.20, 1.13] = This range suggests the true value likely falls between 0.20 and 1.13.
## p = 0.005 = statistically significant, meaning non-transmissible viruses have a measurable effect on AUC_PFU.
## 
## Effect estimate = 0.91 = This suggests that transmissible viruses increase AUC_PFU by 0.91 units compared to non-transmissible ones.
## 95% CI [0.27, 1.55] = The increase is likely between 0.27 and 1.55 units.
## p = 0.006 = statistically significant.
## 
## Random Effects (Group-Level Variability):
## Ferret variance = 0.064 = Some variability comes from individual ferrets.
## Virus variance = 0.174 = Virus differences account for more variability.
## Clade variance = 0.045 = Clades contribute a smaller portion of variability.
## Residual variance = 0.266 = Remaining unexplained variation.

###

norm_data %>%
  filter(Sample != 'NW') %>%
  lme4::lmer(AUC_PFU ~ trans_cat * Virus + (1|ferret) , data = .) %>% 
  #report::report()
  summary()

## Binary transmission
## Conditional RÂ² = 0.65 = The full model explains 65% of the variation in AUC_PFU.
## Marginal RÂ² = 0.57 = The fixed effects (trans_cat & Virus) explain 57% of the variation.
## 
## The starting value for AUC_PFU in non-transmissible viruses (NE/14) is estimated at 0.17.
## 95% CI [-0.14, 0.48] = This means the true value could be slightly negative or positive.
## p = 0.281 = This suggests the baseline is NOT statistically significant, meaning it could vary widely.
##
## Estimate = 1.98 = Transmissible viruses tend to have AUC_PFU values about 2 units higher than non-transmissible viruses.
## 95% CI [1.46, 2.51] = This effect is consistently strong.
## p < .001 = Highly significant, meaning transmissibility is strongly associated with higher AUC_PFU.
##
## Virus CO/137 (+0.92, p < 0.001) = Significantly increases AUC_PFU.
## Virus CA/147 (+1.10, p < 0.001) = Largest increase, highly significant.
## Virus Anhui/1 (-0.94, p < 0.001) = Significantly reduces AUC_PFU.
## Virus MI/90 (-0.86, p = 0.001) = Also lowers AUC_PFU.
## Virus AL/39, BC/PHL, WA/239 = Not significant.
##
## The model dropped 9 coefficients, meaning some Virus-trans_cat interactions were removed because 
## they were redundant or highly correlated. This suggests the dataset might have too many levels 
## or not enough observations for some virus-transmission pairs.
##
## Transmissible viruses have significantly higher AUC_PFU (~2 units more). Some viruses strongly 
## impact AUC_PFU, either increasing (CO/137, CA/147) or decreasing (Anhui/1, MI/90) it. Not all 
## viruses showed a significant effect, meaning their role in AUC_PFU might be weaker

###

norm_data %>%
  filter(Sample != 'NW') %>%
  lme4::lmer(AUC_PFU ~ trans_cat + 
               (1|ferret) + (1|Virus), data = .) %>% 
  #report::report()
  summary()

## Binary transmission
## Conditional RÂ² = 0.66 = The full model explains 66% of the variance in AUC_PFU.
## Marginal RÂ² = 0.31 = The fixed effect (trans_cat) alone explains 31% of the variance.
## 
## The estimated baseline (Intercept) is 0.64, meaning that for non-transmissible viruses, the expected AUC_PFU is around 0.64.
## 95% CI [0.21, 1.08] = This range suggests the true value likely falls between 0.21 and 1.08.
## p = 0.004 = statistically significant, meaning non-transmissible viruses have a measurable effect on AUC_PFU.
## 
## Effect estimate = 0.98 = This suggests that transmissible viruses increase AUC_PFU by 0.98 units compared to non-transmissible ones.
## 95% CI [0.33, 1.63] = The increase is likely between 0.33 and 1.63 units.
## p = 0.003 = statistically significant.
## 
## Random Effects (Group-Level Variability):
## Ferret variance = 0.064 = Some variability comes from individual ferrets.
## Virus variance = 0.211 = Virus differences account for more variability.
## Residual variance = 0.266 = Remaining unexplained variation.

###

norm_data %>%
  filter(Sample != 'NW') %>%
  lme4::lmer(AUC_RNA ~ trans_cat + 
               (1|ferret) + (1|Virus) + (1|clade), data = .) %>% 
  #report::report()
  summary()

## Binary transmission
## Conditional RÂ² = 0.72 = The full model explains 72% of the variance in AUC_RNA.
## Marginal RÂ² = 0.13 = The fixed effect (trans_cat) alone explains 13% of the variance.
## 
## The estimated baseline (Intercept) is 4.02, meaning that for non-transmissible viruses, the expected AUC_RNA is around 4.02.
## 95% CI [3.09, 4.96] = This range suggests the true value likely falls between 3.09 and 4.96.
## p = < 0.001 = statistically significant, meaning non-transmissible viruses have a measurable effect on AUC_RNA.
## 
## Effect estimate = 1.011 = This suggests that transmissible viruses increase AUC_RNA by 1.01 units compared to non-transmissible ones.
## 95% CI [-0.38, 2.41] = The increase is likely between -0.38 and 2.41 units.
## p = 0.154 = not statistically significant.
## 
## Random Effects (Group-Level Variability):
## Ferret variance = 0.1110 = Some variability comes from individual ferrets.
## Virus variance = 1.063 = Virus differences account for more variability.
## Clade variance = 2.456e-10 = Clades contribute barely any variability.
## Residual variance = 0.5624 = Remaining unexplained variation.

###

norm_data %>%
  filter(Sample != 'NW') %>%
  lme4::lmer(AUC_RNA ~ trans_cat * Virus + (1|ferret) , data = .) %>% 
  #report::report()
  summary()

## Binary transmission
## Conditional RÂ² = 0.68 = The full model explains 68% of the variation in AUC_RNA.
## Marginal RÂ² = 0.61 = The fixed effects (trans_cat & Virus) explain 61% of the variation.
## 
## The estimated baseline for AUC_RNA in non-transmissible viruses (NE/14) is 3.44.
## 95% CI [3.02, 3.86] = The true value likely falls between 3.02 and 3.86.
## p < 0.001 = This baseline is statistically significant.
## 
## Effect estimate = 2.29 = Transmissible viruses increase AUC_RNA by 2.29 units compared to non-transmissible ones.
## 95% CI [1.58, 2.99] = The increase is likely between 1.58 and 2.99 units.
## p < 0.001 = Highly significant, meaning transmissibility is strongly associated with higher AUC_RNA values.
## 
## Virus CO/137 (+2.21, p < 0.001) = Significantly increases AUC_RNA.
## Virus CA/147 (+1.30, p < 0.001) = Also increases AUC_RNA significantly.
## Virus Anhui/1 (-0.87, p = 0.019) = Reduces AUC_RNA, statistically significant.
## Virus MI/90 (-1.85, p < 0.001) = Strongly lowers AUC_RNA.
## Virus BC/PHL (-0.77, p = 0.003) = Reduces AUC_RNA.
## Virus AL/39, WA/239 = Not significant, meaning their effect on AUC_RNA is unclear.
## 
## The model dropped 9 coefficients, meaning some Virus-trans_cat interactions didnâ€™t 
## contribute enough unique information. This suggests certain virus-trans_cat combinations
## had too few observations, making them statistically unidentifiable.
## 
## Transmissible viruses have significantly higher AUC_RNA (~2.29 units more). Some 
## viruses (CO/137, CA/147) increase AUC_RNA, while others (MI/90, BC/PHL) reduce it. Not all 
## viruses showed a significant effect, meaning their impact on AUC_RNA may be weak or highly variable.

###

norm_data %>%
  filter(Sample != 'NW') %>%
  lme4::lmer(AUC_RNA ~ trans_cat + 
               (1|ferret) + (1|Virus), data = .) %>% 
  #report::report()
  summary()

## Binary transmission
## Conditional RÂ² = 0.72 = The full model explains 72% of the variance in AUC_RNA.
## Marginal RÂ² = 0.13 = The fixed effect (trans_cat) alone explains 13% of the variance.
## 
## The estimated baseline (Intercept) is 4.02, meaning that for non-transmissible viruses, the expected AUC_RNA is around 4.02.
## 95% CI [3.09, 4.96] = This range suggests the true value likely falls between 3.09 and 4.96.
## p = < 0.001 = statistically significant, meaning non-transmissible viruses have a measurable effect on AUC_RNA.
## 
## Effect estimate = 1.011 = This suggests that transmissible viruses increase AUC_RNA by 1.01 units compared to non-transmissible ones.
## 95% CI [-0.38, 2.41] = The increase is likely between -0.38 and 2.41 units.
## p = 0.154 = not statistically significant.
## 
## Random Effects (Group-Level Variability):
## Ferret variance = 0.1110 = Some variability comes from individual ferrets.
## Virus variance = 1.0627 = Virus differences account for more variability.
## Residual variance = 0.5624 = Remaining unexplained variation.

###

## Overall sum of last two models - Binary transmission
## transmissible viruses increase AUC_PFU by 0.98 units compared to non-transmissible ones
## transmissible viruses increase AUC_RNA by 1.01 units compared to non-transmissible ones
## 
## Linear Mixed Effect Models (above) shows how transmissibility affects RNA and PFU levels.
## Logistic Mixed Effects Models (below) shows how RNA and PFU affect the likelihood of transmissibility.

###

norm_data %>%
  filter(Sample != 'NW') %>%
  lme4::glmer(as.factor(trans_cat) ~ AUC_RNA + AUC_PFU + (1|ferret) + (1|Virus), 
            data = ., family = binomial) %>%
  #report::report()
  summary()

## Binary transmission
## Marginal RÂ² = 0.25 = The fixed effects (AUC_RNA & AUC_PFU) explain 25% of the variation in transmissibility.
## AIC = 23.4 = A low value suggests a good model fit.
## Deviance = 13.4 = Represents overall model uncertaintyâ€”lower values indicate a well-fitting model.
## 
## Intercept = -15.62 = This suggests that if AUC_RNA and AUC_PFU were both zero, 
##   the probability of transmissibility is extremely low.
## p < 0.001 = The intercept is statistically significant.
## 
## Estimate = -0.25 = Higher RNA load reduces the likelihood of transmissibility.
## p < 0.001 = This effect is statistically significant.
## Interpretation = If a virus has high RNA levels, it may be less likely to transmit, 
## possibly because high RNA levels could indicate a different replication pattern.
## 
## Estimate = 1.52 = Higher PFU levels increase the likelihood of transmissibility.
## p < 0.001 = This effect is statistically significant.
## Interpretation = Viruses with higher plaque-forming ability may be more transmissible.
## 
## The random effect for ferret has a variance of 0, meaning individual ferrets arenâ€™t contributing much variation.
## Virus random effect variance is very large (6811) = Suggests Virus is the main driver of variability.

########################################################################################

## Random Forest models

model <- norm_data %>% 
  filter(Sample != 'NW') %>%
  ranger::ranger(as.factor(trans_3cat) ~ AUC_RNA + AUC_PFU + ratio_auc + 
                   RNA + PFU + ratio + Virus + ferret + clade + day, 
                 data = ., classification = TRUE, importance = "impurity")

model$confusion.matrix 
mcc_func(151, 0, 0, 130) ## 1
model$prediction.error
model$variable.importance
## Binary transmission
##    AUC_RNA     AUC_PFU   ratio_auc         RNA         PFU       ratio       Virus      ferret       clade         day 
## 9.63401889 19.28310087  5.49702984  1.01698710  1.31950103  0.58745799 70.25723204  6.97903124 24.57306620  0.02883104 
## Trinary transmission
##    AUC_RNA     AUC_PFU   ratio_auc         RNA         PFU       ratio       Virus      ferret       clade         day 
## 11.28388032 16.42853240  7.90100927  1.34992024  2.55782931  0.90217108 76.24301359 25.71301333 26.44845642  0.09274343 

model2 <- norm_data %>% 
  filter(Sample != 'NW') %>%
  ranger::ranger(as.factor(trans_3cat) ~ AUC_RNA + AUC_PFU + ratio_auc + 
                   Virus + ferret + clade, 
                 data = ., classification = TRUE, importance = "impurity")

model2$confusion.matrix
mcc_func(151, 0, 0, 130) ## 1
model2$prediction.error
model2$variable.importance
## Binary transmission
##    AUC_RNA   AUC_PFU ratio_auc     Virus    ferret     clade 
## 10.154651 19.394417  6.411730 72.530159  7.135661 23.487085 
## Trinary transmission
##    AUC_RNA   AUC_PFU ratio_auc     Virus    ferret     clade 
## 10.658765 17.506043  6.099292 81.478076 26.953615 26.029106 

model3 <- norm_data %>% 
  filter(Sample != 'NW') %>%
  ranger::ranger(as.factor(trans_3cat) ~ AUC_RNA + AUC_PFU + Virus, 
                 data = ., classification = TRUE, importance = "impurity")

model3$confusion.matrix
mcc_func(151, 0, 0, 130) ## 1
model3$prediction.error
model3$variable.importance
## Binary transmission
##  AUC_RNA  AUC_PFU    Virus 
## 26.89531 31.68157 80.05621 
## Trinary transmission
##  AUC_RNA  AUC_PFU    Virus 
## 32.71041 40.61619 95.04011 

model4 <- norm_data %>% 
  filter(Sample != 'NW') %>%
  ranger::ranger(as.factor(trans_3cat) ~ AUC_RNA + AUC_PFU, 
                 data = ., classification = TRUE, importance = "impurity")

model4$confusion.matrix
mcc_func(151, 0, 1, 129) ## 0.9928642
model4$prediction.error
model4$variable.importance
## Binary transmission
##  AUC_RNA  AUC_PFU 
## 61.19619 70.59841
## Trinary transmission
##  AUC_RNA  AUC_PFU 
## 81.91463 79.42982 

model5 <- norm_data %>% 
  filter(Sample != 'NW') %>%
  ranger::ranger(as.factor(trans_3cat) ~ AUC_RNA * AUC_PFU, 
                 data = ., classification = TRUE, importance = "impurity")

model5$confusion.matrix
mcc_func(151, 0, 8, 122) ## 0.9440569
model5$prediction.error
model5$variable.importance
## Binary transmission
##  AUC_RNA         AUC_PFU    AUC_RNA:AUC_PFU 
## 42.46756        47.73651        41.82342 
## Trinary transmission
##  AUC_RNA         AUC_PFU    AUC_RNA:AUC_PFU 
## 53.76437        53.22046        54.45285 

########################################################################################

## Bayesian Generalized (Non-)Linear Multivariate Multilevel Models

## model doesn't want to converge, too much uncertainty
model6 <- norm_data %>% 
  filter(Sample != 'NW') %>%
  brms::brm(trans_cat ~ AUC_RNA + AUC_PFU + (1|ferret) + (1|Virus),
            #control = list(adapt_delta = 0.99, max_treedepth = 15), ## doesn't seem to help
            data = ., family = 'bernoulli', chains = 4, iter = 8000)
summary(model6)


model7 <- norm_data %>% 
  filter(Sample != 'NW') %>%
  brms::brm(trans_cat ~ AUC_RNA + AUC_PFU, 
            data = ., family = 'bernoulli', chains = 4, iter = 8000)
summary(model7)

## Binary transmission
## 281 data points, 4 chains, 8000 iterations per chain (4000 warmup). 
## Bulk Effective Sample Size (ESS) & Tail ESS are good = sampling was effective.
## Rhat = 1.00 for all parameters = good convergence, meaning the chains mixed well
## 
## Estimate = -0.94 = If AUC_RNA and AUC_PFU = 0, the probability of transmissibility is low.
## 95% CI [-2.32, 0.40] = The true value likely falls in this range.
## Some uncertainty = But suggests viruses with very low AUC_RNA & AUC_PFU are less likely to be transmissible.
## 
## Estimate = -0.45 = Higher RNA levels reduce the likelihood of transmissibility.
## 95% CI [-0.89, -0.02] = This effect is statistically significant.
## Interpretation: High RNA levels may not directly drive transmissionâ€”perhaps RNA-heavy viruses arenâ€™t as infectious.
## 
## Estimate = 2.58 = Higher PFU levels increase the likelihood of transmissibility.
## 95% CI [1.85, 3.37] = This effect is statistically significant.
## Interpretation: Viruses with higher plaque-forming ability tend to spread more easily.


model8 <- norm_data %>% 
  filter(Sample != 'NW') %>%
  brms::brm(trans_cat ~ AUC_RNA + AUC_PFU + ratio_auc, 
            data = ., family = 'bernoulli', chains = 4, iter = 8000)
summary(model8)

brms::marginal_effects(model8, effects = "ratio_auc")

## Binary transmission
## 281 data points, 4 chains, 8000 iterations per chain (4000 warmup). 
## Bulk Effective Sample Size (ESS) & Tail ESS are good = sampling was effective.
## Rhat = 1.00 for all parameters = good convergence, meaning the chains mixed well
## 
## Estimate = -1.14 = If AUC_RNA, AUC_PFU, and ratio_auc = 0, the probability of transmissibility is low.
## 95% CI [-2.63, 0.28] = The range suggests some uncertainty but still favors a negative baseline effect.
## Takeaway: Viruses with low values across all predictors tend to be non-transmissible.
## 
## Estimate = 0.13 = Slightly positive, meaning higher RNA may slightly increase transmissibility.
## 95% CI [-0.36, 0.65] = Uncertainty is large, meaning this effect is weak or inconsistent.
## Takeaway: RNA levels donâ€™t strongly predict transmissibility, and the effect may not be statistically reliable.
## 
## Estimate = 2.59 = Strong positive effect, meaning higher PFU levels increase the likelihood of transmissibility.
## 95% CI [1.82, 3.39] = Very strong significance.
## Takeaway: PFU is the best predictor of transmissibilityâ€”viruses with more infectious particles are much more likely to spread.
## 
## Estimate = -0.78 = Negative effect, meaning higher ratio values reduce transmissibility.
## 95% CI [-1.14, -0.42] = Statistically significant.
## Takeaway: The ratio_auc (RNA/PFU), this might mean that viruses with relatively high RNA but low PFU are less transmissible.
## 
## PFU strongly increases transmissibility. 
## RNA has a weak and uncertain effect. 
## Higher ratio_auc (RNA/PFU?) negatively impacts transmissibility, 
## meaning high RNA relative to PFU may indicate lower transmission potential


##########################################################################################
##########################################################################################
### End of Code
##########################################################################################
##########################################################################################